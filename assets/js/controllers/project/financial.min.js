EMAPP.templateCache.put("assets/html/project/financial/view.html?rev=54c02b78aa",'<div class="app-view-project-statistic"><div financial-main></div><div class="modal fade" id="financialModal" ng-if="self.tabActive!==\'deficit\'&&self.modalForm" financial-modal><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" ng-bind="self.modal.departmentname||self.modal.title||\'&nbsp;\'"></h4></div><div class="modal-body" ng-include="\'assets/html/project/financial/main.html?rev=353ca07394\'"></div></div></div></div></div>'),EMAPP.templateCache.put("assets/html/project/financial/main.html?rev=353ca07394",'<ul class="nav nav-tabs"><li ng-if="self.modal" class="active"><a href="javascript:void(0)" ng-bind="self.modal.modaltitle"></a></li><li ng-if="!self.modal" ng-repeat="(key,name) in self.tabs" ng-class="{active:self.tabActive===key}"><a ui-sref="{tab:key}" ng-bind="name"></a></li><li class="pull-right form-inline"><div class="tool-group" ng-if="self.tabActive===\'nearest\'||self.tabActive===\'usage\'" ng-include="\'assets/html/project/financial/tool.html?rev=0e915d2e1d\'"></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.filter()">筛选<i class="emweb web-filter"></i></button></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.export()">导出<i class="emweb web-export-excel"></i></button></div></li></ul><div class="tab-content"><div class="tab-pane subContent active" auto-height="self.autoHeight" ui-i18n="\'zh-cn\'"><div ui-grid="self.gridOptions" class="grid" ui-grid-auto-resize ui-grid-exporter ui-grid-move-columns ui-grid-resize-columns ui-grid-infinite-scroll></div></div></div>'),EMAPP.templateCache.put("assets/html/project/financial/tool.html?rev=0e915d2e1d",'<div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" ng-model="self.fromDate" datetimepicker="{maxRangeTo:\'#\'+self.toDate_ID,rangeDay:30}" id="{{self.fromDate_ID}}"> <i class="emweb web-calendar form-control-feedback"></i></div><div class="input-group">至</div><div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" ng-model="self.toDate" datetimepicker="{minRangeTo:\'#\'+self.fromDate_ID,rangeDay:30,useCurrent:false}" id="{{self.toDate_ID}}"> <i class="emweb web-calendar form-control-feedback"></i></div><div class="input-group" ng-if="self.tabActive===\'nearest\'"><div class="btn-group btn-group-sm"><button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><span ng-bind="self.manual.selected.title||\'所有充值\'">所有充值</span> <span class="caret"></span></button><ul class="dropdown-menu"><li ng-repeat="item in self.manual" ng-class="{active:self.manual.selected.id===item.id}" ng-click="self.manual.selected=item;"><a href="javascript:void(0)" ng-bind="item.title"></a></li></ul></div></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-success" ng-click="self.tabList();"><i class="emweb web-search"></i> 查询</button></div><div class="input-group btn-group-sm">&nbsp;</div><div class="input-group btn-group-sm">&nbsp;</div>'),function(e){angular.module("EMAPP").controller("project.financial",["$stateParams","$scope","$q","$api","$filter","$timeout","uiGridConstants","uuid",function(t,i,a,n,l,d,r,s){e.apply(this,arguments)}]),angular.module("EMAPP").controller("project.financial.modal",["$stateParams","$scope","$q","$api","$filter","$timeout","uiGridConstants","uuid",function(t,i,a,n,l,d,r,s){arguments[0].modal=!0,e.apply(this,arguments)}])}(function(e,t,i,a,n,l,d,r){var s=this,o=new Date;return s.autoHeight=15,s.tabs={nearest:"最近充值",deficit:"欠费商户",all:"全部商户"},s.tabActive=e.tab||"nearest",s.fromDate_ID="form_"+r(8),s.toDate_ID="to_"+r(8),s.fromDate=n("date")(o,"yyyy-MM-01"),s.toDate=n("date")(o,"yyyy-MM-dd"),s.manual=[{id:0,title:"所有充值",val:void 0},{id:1,title:"自助充值",val:0},{id:2,title:"人工充值",val:1}],s.manual.selected=s.manual[0],s.status=[{key:void 0,title:"所有状态"},{key:"CHECKING",title:"等待支付"},{key:"CHECKFAILED",title:"支付失败"},{key:"PROCESSING",title:"正在处理"},{key:"FAILED",title:"处理失败"},{key:"SUCCESS",title:"支付完成"}],s.status.selected=s.status[0],angular.forEach(s.status,function(e){this[e.key]=e.title},s.status),s.filter=function(){s.gridOptions.enableFiltering=!s.gridOptions.enableFiltering,s.gridApi.core.notifyDataChange(d.dataChange.COLUMN)},s.export=function(){var e=n("date")(new Date,"yyyyMMdd_HHmmss");"nearest"===s.tabActive&&(e=[s.fromDate.replace(/-/g,""),s.toDate.replace(/-/g,"")].join("_")),s.gridOptions.exporterCsvFilename=EMAPP.title+"_财务_"+(s.modal?(s.modal.departmentname||s.modal.title||"")+"_"+s.modal.modaltitle:s.tabs[s.tabActive])+"_"+e+".csv",s.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},s.reminder=function(e){a.message.arreargereminder({uid:e.departmentaccount,project:EMAPP.Project.current._id,gateway:"EMAIL"},function(){e.remindercount+=1})},s.openModel=function(e,t,i){s.modalForm=e,s.modalForm.tab=t,s.modalForm.modaltitle=i},s.gridOptions={onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(t,function(){var t=i.defer(),a=function(){t.resolve()},n=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(a,n)},n):n()}(s.load[s.tabActive](!0)),t.promise}),s.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterHeaderFilter:function(e){return"充值金额(元)"===e?e+"(合计："+s.statistic.sumOfAmount+")":"欠费金额(元)"===e?e+"(合计："+s.statistic.sumOfArrears+")":"商户余额(元)"===e?e+"(合计："+s.statistic.sumOfBalance+")":e},exporterFieldCallback:function(e,t,i,a){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[i.field]?'="'+(a||"")+'"':a}},s.load={nearest:function(e){if(!(e&&s.gridOptions.paging&&s.gridOptions.paging.count<=s.gridOptions.paging.pageindex*s.gridOptions.paging.pagesize))return a.business.recentchargelog({from:s.fromDate.replace(/-/g,""),to:s.toDate.replace(/-/g,""),pageindex:(e&&s.gridOptions.paging?s.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:EMAPP.Project.current._id,ismanual:s.manual.selected.val,department:s.modal?s.modal.departmentaccount||s.modal.account:void 0}]},function(t){return t=t.result[EMAPP.Project.current._id]||{},angular.forEach(t.detail,function(e){e.status=s.status[e.status]||e.status,e.timepaid=e.timepaid&&n("date")(1e3*e.timepaid,"yyyy年M月dd日 H:mm:ss")||"",e.timecreate=e.timecreate&&n("date")(1e3*e.timecreate,"yyyy年M月dd日 H:mm:ss")||""}),e?s.gridOptions.data=s.gridOptions.data.concat(t.detail||[]):(s.gridOptions.data=t.detail||[],s.gridOptions.data.length&&l(function(){s.gridApi.core.scrollTo(s.gridOptions.data[0],s.gridOptions.columnDefs[0])})),s.gridOptions.paging=t.paging,s.statistic=t.statistic,t}).$promise},deficit:function(e){return s.load.departments(e)},all:function(e){return s.load.departments(e)},departments:function(e){if(!(e&&s.gridOptions.paging&&s.gridOptions.paging.count<=s.gridOptions.paging.pageindex*s.gridOptions.paging.pagesize))return a.business.departments({project:EMAPP.Project.current._id,amount:"all"===s.tabActive?void 0:0,pageindex:(e&&s.gridOptions.paging?s.gridOptions.paging.pageindex:0)+1,pagesize:50},function(t){return t=t.result[EMAPP.Project.current._id]||{},angular.forEach(t.detail,function(e){e.arrearagetime=e.arrearagetime&&n("date")(1e3*e.arrearagetime,"yyyy年M月dd日 H:mm:ss")||""}),e?s.gridOptions.data=s.gridOptions.data.concat(t.detail||[]):(s.gridOptions.data=t.detail||[],s.gridOptions.data.length&&l(function(){s.gridApi.core.scrollTo(s.gridOptions.data[0],s.gridOptions.columnDefs[0])})),s.gridOptions.paging=t.paging,s.statistic=t.statistic,t}).$promise},usage:function(e){if(!(e&&s.gridOptions.paging&&s.gridOptions.paging.count<=s.gridOptions.paging.pageindex*s.gridOptions.paging.pagesize))return a.business.departmentusage({from:s.fromDate.replace(/-/g,""),to:s.toDate.replace(/-/g,""),pageindex:(e&&s.gridOptions.paging?s.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:EMAPP.Project.current._id,account:s.modal?s.modal.departmentaccount||s.modal.account:void 0}]},function(t){return t=t.result[EMAPP.Project.current._id]||{},e?s.gridOptions.data=s.gridOptions.data.concat(t.detail||[]):(s.gridOptions.data=t.detail||[],s.gridOptions.data.length&&l(function(){s.gridApi.core.scrollTo(s.gridOptions.data[0],s.gridOptions.columnDefs[0])})),angular.forEach(s.gridOptions.data,function(e){e.timepoint=e.timepoint&&n("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||""}),s.gridOptions.paging=t.paging,t}).$promise}},s.tabList=function(){var e=EMAPP.templateCache.get("ui-grid/uiGridHeaderCell");switch(s.tabActive){case"nearest":s.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"title",width:"*",minWidth:200,enablePinning:!1,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" data-toggle="modal" data-target="#financialModal" ng-click="grid.appScope.self.openModel(row.entity,\'nearest\',\'充值记录\')">{{COL_FIELD}}</a></div>'},{displayName:"商户账号",type:"number",name:"account",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",type:"number",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"充值金额(元)",name:"amount",type:"number",width:"*",minWidth:200,headerCellTemplate:function(){return e.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.self.statistic.sumOfAmount}}</div></div><div role="button" tabindex="0"')}},{displayName:"本次余额(元)",name:"balance",type:"number",width:"*",minWidth:120},{displayName:"充值方式",name:"channel",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"充值时间",name:"timepaid",type:"date",width:"*",minWidth:200},{displayName:"操作账号",type:"number",name:"operator",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"订单状态",name:"status",width:"*",minWidth:100,headerCellClass:"text-center",cellClass:"text-center",cellTemplate:"<div class=\"ui-grid-cell-contents\" ng-class=\"{'text-danger':COL_FIELD!=='支付完成'}\">{{COL_FIELD}}</div>"},{displayName:"订单时间",name:"timecreate",type:"date",width:"*",minWidth:200,enablePinning:!1}],s.modal&&s.gridOptions.columnDefs.splice(1,3);break;case"deficit":s.gridOptions.rowHeight=38,s.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"departmentname",width:"*",minWidth:200,enablePinning:!1,enableColumnMenu:!1},{displayName:"商户账号",name:"departmentaccount",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",type:"number",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"欠费金额(元)",type:"number",name:"amount",width:"*",minWidth:200,headerCellTemplate:function(){return e.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.self.statistic.sumOfArrears}}</div></div><div role="button" tabindex="0"')}},{displayName:"欠费时间",name:"arrearagetime",type:"date",width:"*",minWidth:200},{displayName:"已催次数",type:"number",name:"remindercount",width:100,minWidth:100},{displayName:"",name:"send",width:100,minWidth:100,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">催缴通知</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" class="btn btn-xs btn-info" ng-click="grid.appScope.self.reminder(row.entity)">催缴欠费</a></div>'}];break;case"all":s.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"departmentname",width:"*",minWidth:200,enablePinning:!1,enableColumnMenu:!1},{displayName:"商户账号",name:"departmentaccount",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",type:"number",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"商户余额(元)",type:"number",name:"amount",width:"*",minWidth:200,headerCellTemplate:function(){return e.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.self.statistic.sumOfBalance}}</div></div><div role="button" tabindex="0"')}},{displayName:"",name:"nearest",width:100,minWidth:100,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">充值记录</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" data-toggle="modal" data-target="#financialModal" ng-click="grid.appScope.self.openModel(row.entity,\'nearest\',\'充值记录\')">充值记录</a></div>'},{displayName:"",name:"usage",width:100,minWidth:100,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">消费清单</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" data-toggle="modal" data-target="#financialModal" ng-click="grid.appScope.self.openModel(row.entity,\'usage\',\'消费清单\')">消费清单</a></div>'}];break;case"usage":s.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"消费金额(元)",type:"number",name:"cost",width:"*",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:200}]}s.load[s.tabActive]()},!e.modal&&s.tabList(),s});
//# sourceMappingURL=financial.min.js.map
