angular.module("EMAPP").controller("project.analyze",function(){this.groupmode=EMAPP.User.groupmode}),angular.module("EMAPP").controller("project.analyze.group",["$filter","$api",function(e,t){var i=this;return i.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},i.chart={},i.timetypeChange=function(e){i.building_current="",i.energy_current="",i.timetype_current=e,i.groupanalysis()},i.groupanalysis=function(){t.business.groupanalysis({time:e("date")(new Date,"yyyyMMdd"),type:i.timetype_current||"DAY",project:EMAPP.Project.ids},function(e){i.data=e.result,i.check(i.current)})},i.current="consumption",i.check=function(e){i.current=e,i.sheet=[];var t=[],n=[],r=[];angular.forEach(i.data.detail,function(o,c){t.push(o.name=EMAPP.Project[c].title),i.sheet.push(o),angular.forEach(o,function(t,i){"now"===i&&n.push(t[e]),"yoy"===i&&r.push(t[e])})}),i.chart.timeline={chart:{type:"column"},title:!1,xAxis:{categories:t},yAxis:{title:!1},tooltip:{shared:!0},series:[{name:"当前",data:n},{name:"同期",data:r}]}},i.timetypeChange("DAY"),i}]),angular.module("EMAPP").controller("project.analyze.building",["$filter","$api","analyzePieOptions",function(e,t,i){var n=this;return n.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},n.chart={},n.timetypeChange=function(e){n.building_current="",n.energy_current="",n.timetype_current=e,n.buildingstatistic(),n.incomerate(),n.timeline()},n.building_current="",n.building=function(e){n.energy_current="",n.building_current=n.building_current===e?"":e,n.incomerate(),n.timeline()},n.energy_current="",n.energy=function(e){n.energy_current=n.energy_current===e?"":e,n.timeline()},n.buildingstatistic=function(){t.business.buildingstatistic({timetype:n.timetype_current,time:e("date")(new Date,"yyyyMMdd"),project:EMAPP.Project.current._id},function(e){angular.forEach(e.result[EMAPP.Project.current._id],function(e){this.push(e)},n.buildingData=[])})},n.incomerate=function(){t.business.energyincomerate({timetype:n.timetype_current,time:e("date")(new Date,"yyyyMMdd"),project:{project:EMAPP.Project.current._id,building:n.building_current}},function(e){e=e.result[EMAPP.Project.current._id],n.pie=e.pie,angular.forEach(e.sheet,function(e){this.push(e)},n.sheet=[]),n.chart.nowyoy=i(e.pie.nowyoy.now,e.pie.nowyoy.yoy),n.chart.nowbudget=i(e.pie.nowbudget.now,e.pie.nowbudget.budget),n.chart.nowincome=i(e.pie.nowincome.now,e.pie.nowincome.income)})},n.timeline=function(){t.business.energytimeline({timetype:n.timetype_current,time:e("date")(new Date,"yyyyMMdd"),project:[{project:EMAPP.Project.current._id,energytype:n.energy_current,building:n.building_current}]},function(t){var i=[],r=[];angular.forEach(t.result[EMAPP.Project.current._id]||{},function(e,t,n){Object.keys(e).length>i.length&&(n=0,i=[]),angular.forEach(e,function(e,t){this.push(Math.round(100*e)/100),0===n&&i.push(1*t)},e=[]),r.push({data:e,name:{now:"当前能耗",yoy:"同期能耗"}[t]||t})}),n.chart.timeline={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:i,labels:{formatter:function(){return e("date")(this.value,{DAY:"H时",WEEK:"M-d",MONTH:"M-d",YEAR:"M月"}[n.timetype_current])}}},yAxis:{title:!1},tooltip:{xDateFormat:{DAY:"%H时",WEEK:"%m月%d号",MONTH:"%m月%d号",YEAR:"%m月"}[n.timetype_current],pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y:.2f} kWh</span>'},series:r}})},n.timetypeChange("DAY"),n}]),angular.module("EMAPP").controller("project.analyze.socities",["$filter","$api","analyzePieOptions",function(e,t,i){var n=this;return n.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},n.socity_current="",n.socity=function(e){n.socity_current=n.socity_current===e?"":e,n.timeline()},n.timetypeChange=function(r){n.socity_current="",n.timetype_current=r,n.chart={},t.business.socitystatistic({timetype:n.timetype_current,time:e("date")(new Date,"yyyyMMdd"),project:EMAPP.Project.current._id},function(e){angular.forEach(e.result[EMAPP.Project.current._id],function(e){this.push(e)},n.socityData=[])}),t.business.socitydetail({timetype:n.timetype_current,time:e("date")(new Date,"yyyyMMdd"),project:EMAPP.Project.current._id},function(e){e=e.result[EMAPP.Project.current._id],n.pie=e.pie,angular.forEach(e.sheet,function(e){this.push(e)},n.sheet=[]),n.pie.third=n.pie.water||n.pie.gas,n.pie.water?(n.pie.third.unitTitle="吨",n.pie.third.nowTitle="水当期总量",n.pie.third.yoyTitle="水同期总量"):n.pie.gas&&(n.pie.third.unitTitle="立方米",n.pie.third.nowTitle="气当期总量",n.pie.third.yoyTitle="气同期总量"),n.chart.nowyoy=i(e.pie.nowyoy.now,e.pie.nowyoy.yoy),n.chart.electric=i(e.pie.electric.now,e.pie.electric.yoy),n.chart.third=i(e.pie.third.now,e.pie.third.yoy)}),n.timeline()},n.timeline=function(){t.business.socitytimeline({timetype:n.timetype_current,time:e("date")(new Date,"yyyyMMdd"),project:[{project:EMAPP.Project.current._id,socity:n.socity_current}]},function(t){var i=[],r=[];angular.forEach(t.result[EMAPP.Project.current._id]||{},function(e,t,n){Object.keys(e).length>i.length&&(n=0,i=[]),angular.forEach(e.detail,function(e,t){this.push(Math.round(100*e)/100),0===n&&i.push(1*t)},e=[]),r.push({data:e,name:t})}),n.chart.timeline={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:i,labels:{formatter:function(){return e("date")(this.value,{DAY:"H时",WEEK:"M-d",MONTH:"M-d",YEAR:"M月"}[n.timetype_current])}}},yAxis:{title:!1},tooltip:{xDateFormat:{DAY:"%H时",WEEK:"%m月%d号",MONTH:"%m月%d号",YEAR:"%m月"}[n.timetype_current],pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y:.2f} kWh</span>'},series:r}})},n.timetypeChange("DAY"),n}]);