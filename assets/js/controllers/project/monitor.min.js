angular.module("EMAPP").controller("project.monitor",["$scope","$q","$api","$filter","$timeout","uiGridConstants",function(e,t,i,n,l,a){var d=this,o=EMAPP.Project.current&&EMAPP.Project.current._id,r=new Date,c=$("#curveModal"),s=$("#modalCalendar");return d.groupmode=EMAPP.User.groupmode,d.showException=0,d.exceptionChange=function(e,t){d.showException=t,d.deviceType.select(d.deviceType.selected)},d.filter=function(){d.gridOptions.enableFiltering=!d.gridOptions.enableFiltering,d.gridApi.core.notifyDataChange(a.dataChange.COLUMN)},d.export=function(){d.groupmode?d.gridOptions.exporterCsvFilename=EMAPP.title+"_监控_"+d.date.replace(/\-/g,"")+".csv":d.gridOptions.exporterCsvFilename=EMAPP.title+"_监控_"+d.deviceType.selected.name+"_"+n("date")(r,"yyyyMMddHHmmss")+".csv",d.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},d.gridOptions={onRegisterApi:function(i){i.infiniteScroll.on.needLoadMoreData(e,function(){var e=t.defer(),n=function(){e.resolve()},l=function(){i.infiniteScroll.dataLoaded(),e.reject()};return function(e){e?e.then(function(){i.infiniteScroll.saveScrollPercentage(),i.infiniteScroll.dataLoaded(!1,!0).then(n,l)},l):l()}(d.list(!0)),e.promise}),d.gridApi=i},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,n){return{name:!0,addr:!0,title:!0,time:!0}[i.field]?'="'+(n||"")+'"':n}},d.groupmode?(d.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"name",width:"*",minWidth:260,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a target="_blank" ui-sref="dashboard.control({projectid:row.entity.id})" ng-bind="COL_FIELD"></a></div>'},{displayName:"单位面积能耗",type:"number",name:"uaec",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"节能等级",type:"number",name:"ecslevel",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"节能标准",name:"ecsdesc",width:"*",minWidth:150,headerCellClass:"text-right",cellClass:"text-right"}],l(function(){d.list()})):d.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"设备编号",type:"number",name:"gatewayid",width:"*",minWidth:100},{displayName:"设备标识",type:"number",name:"addr",width:"*",minWidth:120},{displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"设备名称",name:"title",width:"*",minWidth:300,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.self.channeldetail(grid.appScope.self.curveModal=row.entity)" ng-bind="COL_FIELD"></a></div>'},{displayName:"通道名称",name:"channel",width:"*",minWidth:150,enableColumnMenu:!1,enableSorting:!1},{displayName:"设备读数",name:"lastvalue",type:"number",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.self.channeldetail(grid.appScope.self.curveModal=row.entity)" ng-bind="COL_FIELD"></a></div>'},{displayName:"通讯时间",name:"time",width:"*",minWidth:200,headerCellClass:"text-right",cellClass:"text-right",cellTemplate:'<div class="ui-grid-cell-contents" ng-if="COL_FIELD">{{COL_FIELD*1|date:\'yyyy年M月dd日 H:mm:ss\'}}</div>'},{displayName:"状态",name:"status",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1,headerCellClass:"text-center",cellClass:"text-center",cellTemplate:function(){return['<div class="ui-grid-cell-contents">','<b ng-show="COL_FIELD===0" class="ng-hide" style="color:#16a085;">正常</b>','<b ng-show="COL_FIELD===1" class="ng-hide" style="color:#c0392b;">数据异常</b>','<b ng-show="COL_FIELD===2" class="ng-hide" style="color:#8e44ad;">通讯异常</b>',"</div>"].join("")}}],o&&i.customer.info({project:o,onlynode:1},function(e){d.customer={core:{data:[{id:"ROOT",parent:"#",text:"全部",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e,t){return"ROOT"===e.id?d.customer.selected=void 0:d.customer.selected=e.id,d.list(),!0},plugins:["search","conditionalselect"]},function e(t,i){angular.forEach(t,function(t,n){t.parent=i,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",e(t.child,t.id),d.customer.core.data.push(t)})}(e.result,"ROOT")}),o&&i.device.type({project:o},function(e){d.deviceType=e.result,d.deviceType.length&&(d.deviceType.select=function(e){d.deviceType.selected=e,d.gridOptions.data=[],d.list()})(d.deviceType[0])}),d.list=function(e){if(!(e&&d.gridOptions.paging&&d.gridOptions.paging.count<=d.gridOptions.paging.pageindex*d.gridOptions.paging.pagesize))return d.groupmode?void i.business.projectdetail({time:n("date")(d.date,"yyyyMM"),project:EMAPP.Project.ids,level:d.level||void 0},function(e){angular.forEach(e=e.result,function(e,t){e.id=t,this.push(e)},e=[]),d.gridOptions.data=e}):i.business.monitor({devicetype:d.deviceType.selected.id,project:o,showexception:d.showException?1:0,mode:"CHANNEL",usesocity:d.customer&&d.customer.selected?1:void 0,socitynode:d.customer&&d.customer.selected,pageindex:(e&&d.gridOptions.paging?d.gridOptions.paging.pageindex:0)+1,pagesize:50},function(t){return t=t.result[o]||{},angular.forEach(t.detail,function(e){this.push(e)},t.detail=[]),e?d.gridOptions.data=d.gridOptions.data.concat(t.detail||[]):(d.gridOptions.data=t.detail||[],d.gridOptions.data.length&&l(function(){d.gridApi.core.scrollTo(d.gridOptions.data[0],d.gridOptions.columnDefs[0])})),d.gridOptions.paging=t.paging,t}).$promise},c.on("shown.bs.modal",function(){l(d.buildLine)}).on("hidden.bs.modal",function(){delete d.curveModal,delete d.timeline}),d.date=n("date")(r,d.groupmode?"yyyy-MM":"yyyy-MM-dd"),s.on("dp.change",function(e){e.oldDate&&l(d.channeldetail)}),d.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},d.timetype_current="DAY",d.timetypeChange=function(e){d.timetype_current=e,s.data("DateTimePicker").format({DAY:"YYYY-MM-DD",WEEK:"YYYY-MM-DD",MONTH:"YYYY-MM",YEAR:"YYYY"}[e]).viewMode({DAY:"days",WEEK:"days",MONTH:"months",YEAR:"years"}[e]).defaultDate(d.date),d.channeldetail()},d.lineType=function(e){d.curveModal.type=e,d.buildLine()},d.buildLine=function(){d.curveModal.enable&&(d.timeline={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:d.curveModal.categories,labels:{formatter:function(){return n("date")(this.value,{DAY:"H",WEEK:"M-dd",MONTH:"M-dd",YEAR:"yyyy-MM"}[d.timetype_current])}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y:.2f} '+d.curveModal.unit+"</span>"},series:[{name:d.curveModal.title,data:d.curveModal[d.curveModal.type]}]})},d.channeldetail=function(){d.curveModal.type=d.curveModal.type||"diff",d.curveModal.categories=[],d.curveModal.diff=[],d.curveModal.scale=[],d.curveModal.enable=!1,i.business.channeldetail({id:d.curveModal.id,timeformat:d.timetype_current,from:d.date.replace(/-/g,""),to:d.date.replace(/-/g,"")},function(e){e.result&&(angular.forEach(e.result.detail,function(e){d.curveModal.categories.push(e.timepoint),d.curveModal.diff.push(e.value),d.curveModal.scale.push(e.total)}),d.curveModal.enable=!0,d.curveModal.start=e.result.start,d.curveModal.unit=e.result.unit,c.hasClass("in")?d.buildLine():c.modal("show"))})},d}]);