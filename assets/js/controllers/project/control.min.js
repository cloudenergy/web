angular.module("EMAPP").controller("project.control",["$scope","$timeout","$api","SweetAlert",function(e,t,n,o){var i=this,a=EMAPP.Project.current&&EMAPP.Project.current._id;a&&n.device.type({project:a},function(e){i.deviceType=e.result,i.deviceType.length&&(i.deviceType.select=function(e){i.deviceType.selected=e,i.monitorData=[],i.list()})(i.deviceType[0])}),a&&n.customer.info({project:a,onlynode:1},function(e){i.customer={core:{data:[{id:"ROOT",parent:"#",text:"全部",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e,t){return"ROOT"===e.id?i.customer.selected=void 0:i.customer.selected=e.id,i.list(),!0},plugins:["search","conditionalselect"]},function e(t,n){angular.forEach(t,function(t,o){t.parent=n,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",e(t.child,t.id),i.customer.core.data.push(t)})}(e.result,"ROOT")}),i.paging={index:1,size:50,total:0,flow:function(e){50+e.target.offsetHeight+e.target.scrollTop>e.target.scrollHeight&&i.monitorData&&!i.monitorData.loading&&i.paging.total>i.paging.index*i.paging.size&&(i.paging.index+=1,i.list(!0))}},i.monitorData=[],i.list=function(e){i.deviceType.selected&&!i.monitorData.loading&&(!e&&angular.extend(i.paging,{index:1,total:0}),i.monitorData.loading=!0,n.business.monitor({devicetype:i.deviceType.selected.id,project:a,ext:{enableMask:1},mode:"SENSOR",usesocity:i.customer&&i.customer.selected?1:void 0,socitynode:i.customer&&i.customer.selected,pageindex:i.paging.index,pagesize:i.paging.size},function(t){t=t.result[a]||{},i.monitorData=e?i.monitorData.concat(t.detail):t.detail,i.paging.total=t.paging.count}))},i.modalSend=function(e){i.modalForm={sensorid:e.id}},i.modalReset=function(){delete i.modalForm.command,delete i.modalForm.data},i.sendCommand=function(){n.control.through(i.modalForm,function(e){!function(e,t){e?(angular.forEach({60000001:"发送超时",60000002:"发送超时",60000003:"发送超时"},function(n,o){parseInt(e)===parseInt(o)&&(t=n)}),t&&o.warning.apply(o,angular.isArray(t)?t:[t])):o.success("发送成功")}(e.code,e.message)})},$("#controlSendCommand").on("hidden.bs.modal",function(){return t(function(){delete i.modalForm,e.formSendCommand.$setPristine()}),!1}),$("#controlSendCommand input[name=command]").on("invalid",function(){return t(e.formSendCommand.command.$setDirty),!1}),$("#controlSendCommand input[name=data]").on("invalid",function(){return t(e.formSendCommand.data.$setDirty),!1})}]);