"use strict";angular.module("app").service("User",["$rootScope","$q","$api","$storage","SweetAlert","MENUCONFIG",function(e,t,r,n,o,u){var c={};angular.extend(e.User=this,{data:void 0,$account:function(o){var c=t.defer();return r.account.info(o||{id:n.get("uid")},function(t){e.Account=t.result,function t(r,n,o){angular.forEach(r,function(r,u){"leaf"!==u&&(r.leaf?(n[u]=!0,e.Rule.$state[o.concat([u]).join(".")]=!0):(o.length>1&&(e.Rule.$state[o.concat([u]).join(".")]=!0),t(r,n[u]=n[u]||{},o.concat([u]))))})}(e.Account.character.rule["/"],e.Rule={$state:{}},[]),angular.forEach(u,function(t){(t.ignore||e.Rule.$state[t.state])&&this.push(t)},e.Menu=[]),c.resolve(e.Account)},c.reject),c.promise},$project:function(t){return r.project.info(angular.extend({id:sessionStorage.projectid||void 0},t||{}),function(t){e.Project=angular.isArray(t.result)&&t.result||t.result&&[t.result]||[],angular.forEach(e.Project,function(t){this.push(t._id),e.Project[t._id]=t},e.Project.ids=[]),c.groupmode?document.title=e.siteTitle="集团平台":(e.Project.current=e.Project[0],document.title=e.siteTitle=e.Project.current.title)},function(){o.warning("没有可用项目")}).$promise},$userinfo:function(n){var o=t.defer();return r.business.userinfo(n||{},function(r){angular.extend(c,r.result),c.groupmode=c.isGroupUser&&!sessionStorage.projectid,t.all([e.User.$account(),e.User.$project()]).then(function(){e.User.data=c,angular.forEach(u,function(e){c.groupmode?e.groupmode&&(this[e.state]=!0,this.push(e)):(this[e.state]=!0,this.push(e))},e.menuData=[]),o.resolve(c)},o.reject)},o.reject),o.promise},$login:function(o){o=o||{};var u=t.defer(),i=Object.keys(o).length,s=o.remember;return delete o.remember,r.auth.login(o,function(t){c=t.result,i&&n.set(c,s),e.User.$userinfo().then(function(){u.resolve(c)},function(e){n.set(null),u.reject(e)})},u.reject),u.promise},$logout:function(t){return r.auth.logout(t||{},function(){delete e.User.data,delete sessionStorage.projectid,n.set(null)}).$promise}})}]);