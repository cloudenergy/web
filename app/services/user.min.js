"use strict";angular.module("app").service("User",["$rootScope","$q","$api","$fundebug","$storage","SweetAlert","MENUCONFIG",function(e,t,r,n,o,u,c){var s={};angular.extend(e.User=this,{data:void 0,$account:function(n){var u=t.defer();return r.account.info(n||{id:o.get("uid")},function(t){t.result&&Object.keys(t.result).length?(e.Account=t.result,function t(r,n,o){angular.forEach(r,function(r,u){"leaf"!==u&&(r.leaf?(n[u]=!0,e.Rule.$state[o.concat([u]).join(".")]=!0):(o.length>1&&(e.Rule.$state[o.concat([u]).join(".")]=!0),t(r,n[u]=n[u]||{},o.concat([u]))))})}(e.Account.character.rule["/"],e.Rule={$state:{}},[]),angular.forEach(c,function(t){(t.ignore||e.Rule.$state[t.state])&&this.push(t)},e.Menu=[]),u.resolve(e.Account)):u.reject(t)},u.reject),u.promise},$project:function(n){var o=t.defer();return r.project.info(angular.extend({id:sessionStorage.projectid||void 0},n||{}),function(t){t.result&&Object.keys(t.result).length?(e.Project=angular.isArray(t.result)&&t.result||t.result&&[t.result]||[],angular.forEach(e.Project,function(t){this.push(t._id),e.Project[t._id]=t},e.Project.ids=[]),s.groupmode?document.title=e.siteTitle="集团平台":(e.Project.current=e.Project[0],document.title=e.siteTitle=e.Project.current.title)):o.reject(t)},function(e){u.warning("没有可用项目"),o.reject(e)}),o.promise},$userinfo:function(o){var u=t.defer();return r.business.userinfo(o||{},function(r){angular.extend(s,r.result),s.groupmode=s.isGroupUser&&!sessionStorage.projectid,t.all([e.User.$account(),e.User.$project()]).then(function(){e.User.data=s,angular.forEach(c,function(e){s.groupmode?e.groupmode&&(this[e.state]=!0,this.push(e)):(this[e.state]=!0,this.push(e))},e.menuData=[]);var t=angular.copy(s);delete t.character.rule,n.metaData({UserData:t}),u.resolve(s)},u.reject)},u.reject),u.promise},$login:function(n){n=n||{};var u=t.defer(),c=Object.keys(n).length,a=n.remember;return delete n.remember,r.auth.login(n,function(t){s=t.result,c&&o.set(s,a),e.User.$userinfo().then(function(){u.resolve(s)},function(e){o.set(null),u.reject(e)})},u.reject),u.promise},$logout:function(t){return r.auth.logout(t||{},function(){delete e.User.data,delete sessionStorage.projectid,o.set(null)}).$promise}})}]);