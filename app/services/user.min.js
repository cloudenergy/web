"use strict";angular.module("app").service("User",["$rootScope","$q","$api","$fundebug","$storage","SweetAlert","MENUCONFIG",function(e,t,r,n,o,u,c){var a={};angular.extend(e.User=this,{data:void 0,$account:function(n){var u=t.defer();return r.account.info(n||{id:o.get("uid")},function(t){e.Account=t.result,function t(r,n,o){angular.forEach(r,function(r,u){"leaf"!==u&&(r.leaf?(n[u]=!0,e.Rule.$state[o.concat([u]).join(".")]=!0):(o.length>1&&(e.Rule.$state[o.concat([u]).join(".")]=!0),t(r,n[u]=n[u]||{},o.concat([u]))))})}(e.Account.character.rule["/"],e.Rule={$state:{}},[]),angular.forEach(c,function(t){(t.ignore||e.Rule.$state[t.state])&&this.push(t)},e.Menu=[]),u.resolve(e.Account)},u.reject),u.promise},$project:function(t){return r.project.info(angular.extend({id:sessionStorage.projectid||void 0},t||{}),function(t){e.Project=angular.isArray(t.result)&&t.result||t.result&&[t.result]||[],angular.forEach(e.Project,function(t){this.push(t._id),e.Project[t._id]=t},e.Project.ids=[]),a.groupmode?document.title=e.siteTitle="集团平台":(e.Project.current=e.Project[0],document.title=e.siteTitle=e.Project.current.title)},function(){u.warning("没有可用项目")}).$promise},$userinfo:function(o){var u=t.defer();return r.business.userinfo(o||{},function(r){angular.extend(a,r.result),a.groupmode=a.isGroupUser&&!sessionStorage.projectid,t.all([e.User.$account(),e.User.$project()]).then(function(){e.User.data=a,angular.forEach(c,function(e){a.groupmode?e.groupmode&&(this[e.state]=!0,this.push(e)):(this[e.state]=!0,this.push(e))},e.menuData=[]);var t=angular.copy(a);delete t.character.rule,n.metaData({UserData:t}),u.resolve(a)},u.reject)},u.reject),u.promise},$login:function(n){n=n||{};var u=t.defer(),c=Object.keys(n).length,i=n.remember;return delete n.remember,r.auth.login(n,function(t){a=t.result,c&&o.set(a,i),e.User.$userinfo().then(function(){u.resolve(a)},function(e){o.set(null),u.reject(e)})},u.reject),u.promise},$logout:function(t){return r.auth.logout(t||{},function(){delete e.User.data,delete sessionStorage.projectid,o.set(null)}).$promise}})}]);