angular.module("app").component("financial",{templateUrl:"app/modules/financial/financial.html?rev=7769491aed",controller:["$scope","$element",function(e,t){var i=this,n=t.find(".financial-modal");n.on("hidden.bs.modal",function(){delete i.modal,delete i.modalTab,delete i.modalTitle}),i.openModel=function(e,t,a){i.modal=e,i.modalTab=t,i.modalTitle=a,n.modal("show")}}]}),angular.module("app").component("financialMain",{templateUrl:"app/modules/financial/main.html?rev=6820e1fb30",bindings:{modal:"<",modalTab:"<",modalTitle:"<",openModel:"<"},controller:["$templateCache","$stateParams","$scope","$q","$api","$filter","$timeout","uiGridConstants",function(e,t,i,n,a,d,l,r){var o=this,s=new Date;o.autoHeight=o.modal&&175||15,o.action=t.action,o.account=t.account,o.tabs={nearest:"最近充值",deficit:"欠费商户",all:"全部商户"},o.tabActive=o.modalTab||t.tab||"nearest",o.fromDate_ID="form_"+parseInt(1e3*Math.random(),10),o.toDate_ID="to_"+parseInt(1e3*Math.random(),10),o.fromDate=t.startDate||d("date")(s,"yyyy-MM-01"),o.toDate=t.endDate||d("date")(s,"yyyy-MM-dd"),o.manual=[{id:0,title:"所有充值",val:void 0},{id:1,title:"自助充值",val:0},{id:2,title:"人工充值",val:1}],o.manual.selected=o.manual[0],o.status=[{key:void 0,title:"所有状态"},{key:"CHECKING",title:"等待支付"},{key:"CHECKFAILED",title:"支付失败"},{key:"PROCESSING",title:"正在处理"},{key:"FAILED",title:"处理失败"},{key:"SUCCESS",title:"支付完成"}],o.status.selected=o.status[0],angular.forEach(o.status,function(e){this[e.key]=e.title},o.status),o.filter=function(){o.gridOptions.enableFiltering=!o.gridOptions.enableFiltering,o.gridApi.core.notifyDataChange(r.dataChange.COLUMN)},o.export=function(){var e=[APP.title,"财务"];o.modal?(e.push(o.modal.departmentname||o.modal.title||""),e.push(o.modalTitle||"")):e.push(o.tabs[o.tabActive]||""),"nearest"===o.tabActive?(e.push(o.fromDate.replace(/-/g,"")),e.push(o.toDate.replace(/-/g,""))):e.push(d("date")(new Date,"yyyyMMdd_HHmmss")),o.gridOptions.exporterCsvFilename=e.join("_")+".csv",o.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},o.reminder=function(e){a.message.remindrecharge({uid:e.departmentaccount,project:APP.Project.current._id},function(){e.remindercount+=1})},o.gridOptions={onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(i,function(){var t=n.defer(),i=function(){t.resolve()},a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(i,a)},a):a()}(o.load[o.tabActive](!0)),t.promise}),o.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterHeaderFilter:function(e){return"充值金额(元)"===e?e+"(合计："+o.statistic.sumOfAmount+")":"欠费金额(元)"===e?e+"(合计："+o.statistic.sumOfArrears+")":"商户余额(元)"===e?e+"(合计："+o.statistic.sumOfBalance+")":e},exporterFieldCallback:function(e,t,i,n){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[i.field]?'="'+(n||"")+'"':n}},o.load={nearest:function(e){if(!(e&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize))return a.business.recentchargelog({from:o.fromDate.replace(/-/g,""),to:o.toDate.replace(/-/g,""),pageindex:(e&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:APP.Project.current._id,ismanual:o.manual.selected.val,department:o.modal?o.modal.departmentaccount||o.modal.account:void 0}]},function(t){return t=t.result[APP.Project.current._id]||{},angular.forEach(t.detail,function(e){e.status=o.status[e.status]||e.status,e.timepaid=e.timepaid&&d("date")(1e3*e.timepaid,"yyyy年M月dd日 H:mm:ss")||"",e.timecreate=e.timecreate&&d("date")(1e3*e.timecreate,"yyyy年M月dd日 H:mm:ss")||""}),e?o.gridOptions.data=o.gridOptions.data.concat(t.detail||[]):(o.gridOptions.data=t.detail||[],o.gridOptions.data.length&&l(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])})),o.gridOptions.paging=t.paging,o.statistic=t.statistic,t}).$promise},deficit:function(e){return o.load.departments(e)},all:function(e){return o.load.departments(e)},departments:function(e){if(!(e&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize))return a.business.departments({project:APP.Project.current._id,amount:"all"===o.tabActive?void 0:0,pageindex:(e&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:50},function(t){return t=t.result[APP.Project.current._id]||{},angular.forEach(t.detail,function(e){e.arrearagetime=e.arrearagetime&&d("date")(1e3*e.arrearagetime,"yyyy年M月dd日 H:mm:ss")||""}),e?o.gridOptions.data=o.gridOptions.data.concat(t.detail||[]):(o.gridOptions.data=t.detail||[],o.gridOptions.data.length&&l(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])})),o.gridOptions.paging=t.paging,o.statistic=t.statistic,t}).$promise},usage:function(e){if(!(e&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize))return a.business.departmentusage({from:o.fromDate.replace(/-/g,""),to:o.toDate.replace(/-/g,""),pageindex:(e&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:APP.Project.current._id,account:o.modal?o.modal.departmentaccount||o.modal.account:void 0}]},function(t){return t=t.result[APP.Project.current._id]||{},e?o.gridOptions.data=o.gridOptions.data.concat(t.detail||[]):(o.gridOptions.data=t.detail||[],o.gridOptions.data.length&&l(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])})),angular.forEach(o.gridOptions.data,function(e){e.timepoint=e.timepoint&&d("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||""}),o.gridOptions.paging=t.paging,t}).$promise}},o.tabList=function(){var t=e.get("ui-grid/uiGridHeaderCell");switch(o.tabActive){case"nearest":o.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"title",width:"*",minWidth:200,enablePinning:!1,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.$ctrl.openModel(row.entity,\'nearest\',\'充值记录\')">{{COL_FIELD}}</a></div>'},{displayName:"商户账号",type:"number",name:"account",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",type:"number",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"充值金额(元)",name:"amount",type:"number",width:"*",minWidth:200,headerCellTemplate:function(){return t.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.$ctrl.statistic.sumOfAmount}}</div></div><div role="button" tabindex="0"')}},{displayName:"本次余额(元)",name:"balance",type:"number",width:"*",minWidth:120},{displayName:"充值方式",name:"channel",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"充值时间",name:"timepaid",type:"date",width:"*",minWidth:200},{displayName:"操作账号",type:"number",name:"operator",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"订单状态",name:"status",width:"*",minWidth:100,headerCellClass:"text-center",cellClass:"text-center",cellTemplate:"<div class=\"ui-grid-cell-contents\" ng-class=\"{'text-danger':COL_FIELD!=='支付完成'}\">{{COL_FIELD}}</div>"},{displayName:"订单时间",name:"timecreate",type:"date",width:"*",minWidth:200,enablePinning:!1}],o.modal&&o.gridOptions.columnDefs.splice(1,3);break;case"deficit":o.gridOptions.rowHeight=38,o.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"departmentname",width:"*",minWidth:200,enablePinning:!1,enableColumnMenu:!1},{displayName:"商户账号",name:"departmentaccount",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",type:"number",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"欠费金额(元)",type:"number",name:"amount",width:"*",minWidth:200,headerCellTemplate:function(){return t.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.$ctrl.statistic.sumOfArrears}}</div></div><div role="button" tabindex="0"')}},{displayName:"欠费时间",name:"arrearagetime",type:"date",width:"*",minWidth:200},{displayName:"已催次数",type:"number",name:"remindercount",width:100,minWidth:100},{displayName:"",name:"send",width:100,minWidth:100,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">催缴通知</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" class="btn btn-xs btn-info" ng-click="grid.appScope.$ctrl.reminder(row.entity)">催缴欠费</a></div>'}];break;case"all":o.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"departmentname",width:"*",minWidth:200,enablePinning:!1,enableColumnMenu:!1},{displayName:"商户账号",name:"departmentaccount",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",type:"number",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"商户余额(元)",type:"number",name:"amount",width:"*",minWidth:200,headerCellTemplate:function(){return t.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.$ctrl.statistic.sumOfBalance}}</div></div><div role="button" tabindex="0"')}},{displayName:"",name:"nearest",width:100,minWidth:100,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">充值记录</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.$ctrl.openModel(row.entity,\'nearest\',\'充值记录\')">充值记录</a></div>'},{displayName:"",name:"usage",width:100,minWidth:100,enablePinning:!1,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">消费清单</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.$ctrl.openModel(row.entity,\'usage\',\'消费清单\')">消费清单</a></div>'}];break;case"usage":o.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"消费金额(元)",type:"number",name:"cost",width:"*",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:200}]}o.load[o.tabActive]()},o.tabList()}]});