angular.module("app").component("main",{templateUrl:"app/modules/main/main.html?rev=207fe19790",controller:["$api","$filter","$timeout",function(e,t,a){var i=this;i.viewDate=new Date,i.chart={},i.groupmode=APP.User.groupmode,a(function(e){e=$("datetimepicker").on("dp.show",function(){a(function(){e.data("DateTimePicker").maxDate(new Date)})}).on("dp.change",function(e){var a=angular.equals(e.date.format("YYYYMM"),t("date")(i.viewDate,"yyyyMM")),n=angular.equals(e.date.format("YYYYMMDD"),t("date")(i.viewDate,"yyyyMMdd"));n||(i.viewDate=e.date._d),a&&!n&&i.bindTD(),!a&&i.calendar(i.viewDate),!n&&i.dailycost(i.viewDate),!a&&i.monthlykgce(i.viewDate),!a&&!i.groupmode&&i.energyconstitute(i.viewDate),!a&&!i.groupmode&&i.dailysensordetail(i.viewDate),!a&&i.groupmode&&i.energyeffectiverate(i.viewDate),!a&&i.groupmode&&i.projectdetail(i.viewDate)}).on("dp.update",function(a){angular.equals(a.viewDate.format("YYYYMM"),t("date")(i.viewDate,"yyyyMM"))?i.bindTD():e.data("DateTimePicker").maxDate(new Date).defaultDate(a.viewDate.format("YYYYMMDD")>t("date")(new Date,"yyyyMMdd")?new Date:a.viewDate._d)}),i.calendar(i.viewDate),i.dailycost(i.viewDate),i.monthlykgce(i.viewDate),!i.groupmode&&i.energyconstitute(i.viewDate),!i.groupmode&&i.dailysensordetail(i.viewDate),i.groupmode&&i.energyeffectiverate(i.viewDate),i.groupmode&&i.projectdetail(i.viewDate)}),i.bindTD=function(){i.calendarData&&$("datetimepicker .datepicker-days table tbody td.day").each(function(){if(!/old|new/i.test(this.className)){var e=$(this),t=e.data("day");e.removeClass("emstatus-up").removeClass("emstatus-down").removeClass("emstatus-keep"),i.calendarData.detail[t]&&e.addClass(i.calendarData.detail[t]>i.calendarData.average?"emstatus-up":i.calendarData.detail[t]<i.calendarData.average?"emstatus-down":"emstatus-keep")}}),$("datetimepicker .datepicker-days table tbody td.active").click(function(){return!1})},i.calendar=function(a){e.business.calendar({time:t("date")(a,"yyyyMM"),project:APP.Project.ids,assemble:i.groupmode},function(e){e=i.groupmode?e.result:e.result[APP.Project.current._id],i.calendarData=e||{},i.calendarData.detail=i.calendarData.detail,i.groupmode?i.calendarData.average=i.calendarData.buildingConsumption/(i.calendarData.detail&&Object.keys(i.calendarData.detail).length||0):i.calendarData.average=i.calendarData.buildingConsumption/(i.calendarData.detail&&i.calendarData.detail.length||0),angular.forEach(i.calendarData.detail,function(e,a){i.groupmode?this[t("date")(a,"yyyy-MM-dd")]=e:this[t("date")(e._id,"yyyy-MM-dd")]=e.value},i.calendarData.detail={}),i.bindTD()})},i.dailycost=function(a){e.business.dailycost({time:t("date")(a,"yyyyMMdd"),project:APP.Project.ids,assemble:i.groupmode},function(e){e=i.groupmode?e.result||{}:e.result[APP.Project.current._id]||{},e.cost=Math.round(e.cost),i.currentDayqoq=Math.round(100*e.qoqPercent)/100,i.currentDayyoy=Math.round(100*e.yoyPercent)/100,i.chart.dailycost={chart:{margin:[0,0,0,0],style:{textAlign:"center"},type:"pie"},title:{text:'<div class="pieTitle">今日费用</div><div class="pieNumber">'+e.cost+'</div><div class="pieUnit">元</div>',verticalAlign:"middle",useHTML:!0,y:-12},tooltip:!1,plotOptions:{pie:{dataLabels:!1,innerSize:"85%"}},series:[{data:[e.cost]}]}})},i.monthlykgce=function(a){e.business.monthlykgce({time:t("date")(a,"yyyyMM"),project:APP.Project.ids},function(e){var t=[],a=0,n=0,r=0;i.groupmode?(angular.forEach(e.result,function(e,t){this.push([APP.Project[t].title,e.kgce]),a+=e.kgce,n+=e.kgceperunitarea,r+=e.kwhperunitarea},e.detail=[]),t.push({data:e.detail})):(e=e.result[APP.Project.current._id]||{},angular.forEach(e.detail,function(e,t){this.push([t,e])},e.detail=[]),t.push({data:e.detail}),a=e.kgce,n=e.kgceperunitarea,r=e.kwhperunitarea),i.currentMonthKgceperunitarea=Math.round(100*n)/100,i.currentMonthKwhperunitarea=Math.round(100*r)/100,i.chart.monthlykgce={chart:{marginBottom:0,marginLeft:0,marginRight:140,marginTop:0,style:{textAlign:"center"},type:"pie"},title:{text:'<div class="pieTitle">月综合能耗</div><div class="pieNumber">'+Math.round(100*a)/100+'</div><div class="pieUnit">千克煤</div>',verticalAlign:"middle",useHTML:!0,x:-70,y:-12},tooltip:{pointFormat:" <b>{point.y}</b> 千克煤"},plotOptions:{pie:{dataLabels:!1,innerSize:"85%",showInLegend:!0}},legend:{verticalAlign:"middle",layout:"vertical",labelFormatter:function(){return'<div style="text-align:left;">'+Math.round(10*this.percentage)/10+"% "+this.name+'</div><div style="color:#BBB;text-align:left;">'+this.y+"KGce</div>"},itemWidth:100,useHTML:!0,x:140},series:t}})},i.energyconstitute=function(a){e.business.energyconstitute({time:t("date")(a,"yyyyMM"),project:APP.Project.current._id},function(e){var a=[],n=[];angular.forEach(e.result[APP.Project.current._id]||{},function(e,t,i){Object.keys(e).length>a.length&&(i=0,a=[]),angular.forEach(e,function(e,t){this.push(e),0===i&&a.push(parseInt(t))},e=[]),n.push({data:e,name:t})}),i.chart.energyconstitute={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:a,labels:{formatter:function(){return t("date")(this.value,"M-dd")}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y}元</span>'},series:n}})},i.dailysensordetail=function(a){e.business.dailysensordetail({time:t("date")(a,"yyyyMM"),project:APP.Project.current._id},function(e){e=e.result[APP.Project.current._id]||{};var n=0;angular.forEach(e,function(e,t){this.push([t,e]),n+=100*e},e=[]),i.chart.dailysensordetail={chart:{marginLeft:-10,marginRight:200,style:{textAlign:"left"},type:"pie"},title:{text:'<div class="pieTitle">'+t("date")(a,"yyyy年MM月")+"能耗</div><div>"+n/100+"KWh</div>",verticalAlign:"middle",useHTML:!0,x:-100,y:-5},tooltip:{pointFormat:"<b>{point.y:.2f}kWh {point.percentage:.2f}%</b>"},plotOptions:{pie:{dataLabels:!1,innerSize:"85%",showInLegend:!0}},legend:{align:"center",verticalAlign:"middle",layout:"vertical",labelFormatter:function(){var e=Math.round(10*this.percentage)/10+"% "+this.name,t=Math.round(100*(this.y||0))/100+"kWh";return['<span class="center-block" title="'+e+'">'+e+"</span>",'<span class="center-block text-muted" title="'+t+'">'+t+"</span>"].join("")},itemWidth:200,x:140,useHTML:!0},series:[{cropThreshold:0,turboThreshold:0,data:e}]}})},i.energyeffectiverate=function(a){e.business.energyeffectiverate({time:t("date")(a,"yyyyMM"),project:APP.Project.ids,assemble:i.groupmode},function(e){var a=[],n=[];angular.forEach(e.result||{},function(e,t,i){Object.keys(e).length>a.length&&(i=0,a=[]),angular.forEach(e,function(e,t){this.push(Math.round(100*e.value)/100),0===i&&a.push(1e3*t)},e=[]),n.push({data:e,name:{now:"本月能效",yoy:"同期能效"}[t]||t})}),i.chart.energyeffectiverate={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:a,labels:{formatter:function(){return t("date")(this.value,"M-dd")}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y}KWh</span>'},series:n}})},i.projectdetail=function(a){e.business.projectdetail({time:t("date")(a,"yyyyMM"),project:APP.Project.ids},function(e){angular.forEach(e.result,function(e){e.data=[0,0,0,0,0],e.data[e.ecslevel-1]=e.uaec,this.push({name:e.name,data:e.data})},e.series=[]),i.chart.projectdetail={chart:{type:"bar"},title:!1,xAxis:{categories:["0-1.8 KWh","1.8-3.8 KWh","3.8-5.7 KWh","5.7-7.7 KWh","7.7-∞ KWh"]},yAxis:{title:!1},tooltip:{valueSuffix:" KWh"},legend:{layout:"vertical",align:"right",verticalAlign:"bottom",y:-20,floating:!0,borderWidth:1},series:e.series}})}}]});