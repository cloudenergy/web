"use strict";angular.module("app").component("statistic",{templateUrl:"app/modules/statistic/statistic.html?rev=bd3f2f7af1",controller:["$rootScope","$window","$templateCache","$q","$api","$filter","$timeout","$stateParams","uiGridConstants","i18nService","$scope",function(a,t,e,i,r,n,l,s,d,o,m){var p=this,c=a.Project.current&&a.Project.current._id,h="departmenttitle_"+a.User.data.uid+c,u={project:[]};if(angular.forEach(a.Project,function(e){u.project.push({id:e._id})}),o.add("zh-cn",{aggregation:{sum:"合计："}}),p.gridOptions={onRegisterApi:function(e){p.gridApi=e,p.departmentreport&&l(function(){e.grouping&&e.grouping.clearGrouping(),e.grouping&&e.grouping.groupColumn("title"),e.core.notifyDataChange(d.dataChange.COLUMN)})},enableColumnMenus:!1,enableRowSelection:!1,enableGroupHeaderSelection:!1,enableRowHeaderSelection:!1,enableSorting:!0,rowHeight:34,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,a){return{name:!0,"id.substr(12,12)":!0,"channeldid.substr(12,12)":!0}[i.field]?'="'+(a||"")+'"':a},showColumnFooter:!0,treeRowHeaderAlwaysVisible:!0},p.tabClick=function(e){p.startDate="dailyreport"===e?moment().format("YYYY-MM-DD"):moment().subtract(30,"days").format("YYYY-MM-DD"),p.endDate=moment().format("YYYY-MM-DD"),p.rangeDay={settlereport:183,monthlyreport:31}[e]||0,p.tabActive=e,p.report(e)},p.report=function(t){var i=p.billingserviceData&&p.billingserviceData.selected&&p.billingserviceData.selected.id;switch(u.project&&(u.project=[]),angular.forEach(a.Project,function(e){u.project.push({id:e._id,devicetype:i||void 0})}),t){case"settlereport":case"monthlyreport":case"projectreport":u.from=p.startDate.replace(/\-/g,""),u.to=p.endDate.replace(/\-/g,"");break;case"dailyreport":u.time=p.startDate.replace(/\-/g,"");break;case"departmentreport":u.from=p.startDate.replace(/\-/g,""),u.to=p.endDate.replace(/\-/g,"")}switch(t){case"settlereport":p.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,pinnedLeft:!0,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"智能仪表名称",name:"name",width:"*",pinnedLeft:!0,minWidth:200},{displayName:"仪表类型",name:"devicetype",width:"*",minWidth:80},{displayName:"通道名称",name:"channelname",width:"*",minWidth:80},{displayName:moment(p.startDate).format("YYYY年M月D日"),name:"min",type:"number",width:"*",minWidth:140,cellClass:"text-right",headerCellClass:"text-right"},{displayName:moment(p.endDate).format("YYYY年M月D日"),name:"max",type:"number",width:"*",minWidth:140,cellClass:"text-right",headerCellClass:"text-right"},{displayName:"能耗总值",name:"sum",type:"number",width:"*",minWidth:130,cellClass:"text-right",aggregationType:d.aggregationTypes.sum,filters:[{condition:d.filter.GREATER_THAN,placeholder:"大于"},{condition:d.filter.LESS_THAN,placeholder:"小于"}],headerCellClass:"text-right grid-cell-50",footerCellFilter:"number:2"},{displayName:"单价",name:"price",type:"number",width:"*",minWidth:100,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"倍率系数",name:"comi",type:"number",width:"*",minWidth:100,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"费用",name:"cost",type:"number",width:"*",minWidth:130,cellClass:"text-right",aggregationType:d.aggregationTypes.sum,filters:[{condition:d.filter.GREATER_THAN,placeholder:"大于"},{condition:d.filter.LESS_THAN,placeholder:"小于"}],headerCellClass:"text-right grid-cell-50",footerCellFilter:"number:2"}];break;case"monthlyreport":p.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,pinnedLeft:!0,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"智能仪表名称",name:"name",width:"*",pinnedLeft:!0,minWidth:180},{displayName:"仪表类型",name:"devicetype",width:"*",minWidth:80},{displayName:"通道名称",name:"channelname",width:"*",minWidth:80},{displayName:"月能耗",type:"number",name:"monthlySum",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"日平均",type:"number",name:"dailyAvg",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"}];break;case"dailyreport":p.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,pinnedLeft:!0,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"智能仪表名称",name:"name",width:"*",pinnedLeft:!0,minWidth:200},{displayName:"仪表类型",name:"devicetype",width:"*",minWidth:80},{displayName:"通道名称",name:"channelname",width:"*",minWidth:80},{displayName:"日能耗",type:"number",name:"dailysum",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"}];break;case"projectreport":p.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"name",width:"*",minWidth:260},{displayName:"总用能",type:"number",name:"consumption",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"总费用",type:"number",name:"cost",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单位用能",type:"number",name:"uaec",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单位电能",type:"number",name:"uaeec",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"}];break;case"departmentreport":p.gridOptions.columnDefs=[{displayName:"商户名称",name:"title",width:"*",minWidth:260,grouping:{groupPriority:0},sort:{priority:0}},{displayName:"智能仪表名称",type:"number",name:"sensor.title",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"期初读数",type:"number",name:"sensor.from",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:" 期末读数",type:"number",name:"sensor.to",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"用量",type:"number",name:"sensor.usage",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单价",type:"number",name:"sensor.price",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"费用",type:"number",name:"sensor.cost",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"}]}r.business[t](u,function(e){switch(sessionStorage[h]&&p.gridOptions.columnDefs.push({displayName:"商户名称",name:"departmenttitle",width:"*",minWidth:200}),t){case"departmentreport":e=e.result[c]||{},p.statistic=e.statistic||{},e=e.detail||[],p.group=[],angular.forEach(e,function(a){a.sensors.length?angular.forEach(a.sensors,function(e,t){var i={};angular.copy(a,i),i.sensor=e,p.group.push(i)}):p.group.push(a)}),e=p.group,l(function(){p.gridApi.treeBase.expandAllRows()},1e3);break;case"settlereport":e=e.result[c]||{},p.statistic=e.statistic||{},e=e.detail||[],p.gridOptions.columnDefs.unshift({displayName:"设备ID",name:"id.substr(12,12)",type:"number",width:"*",minWidth:120}),p.gridOptions.columnDefs.push({displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100});break;case"monthlyreport":(e=e.result[c]||[]).length&&(angular.forEach(e[0].usage,function(e,t){this.push({displayName:n("date")(t,"M-d"),name:"day"+n("date")(t,"yyyyMMdd"),width:"*",minWidth:60,headerCellClass:"text-right",cellClass:"text-right"})},p.gridOptions.columnDefs),p.gridOptions.columnDefs.unshift({displayName:"设备ID",type:"number",name:"channeldid.substr(12,12)",width:"*",minWidth:120}),p.gridOptions.columnDefs.push({displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100}));break;case"dailyreport":(e=e.result[c]||[]).length&&angular.forEach(e[0].usage,function(e,t){t=n("date")(t,"H"),this.push({displayName:t+"时",name:"hour"+t,width:"*",minWidth:50,headerCellClass:"text-right",cellClass:"text-right"})},p.gridOptions.columnDefs),p.gridOptions.columnDefs.unshift({displayName:"设备ID",type:"number",name:"channeldid.substr(12,12)",width:"*",minWidth:120}),p.gridOptions.columnDefs.push({displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100});break;case"projectreport":angular.forEach(e.result,function(i){angular.forEach(i,function(e,t){i[t]="name"===t?e:Math.round(100*e)/100}),this.push(i)},e=[])}p.rebuildData(e)})},a.User.data.groupmode)p.tabs={projectreport:"项目总用能"},p.tabClick("projectreport");else{r.device.type({project:a.Project.ids},function(e){angular.forEach(e.result||{},function(e){this.push(e)},p.billingserviceData=[])});var g=i.defer();sessionStorage[h]?(g.resolve(),g=g.promise):g=r.business.departmentreport({project:[{check:!0,id:c}]},function(e){e=e.result[c],sessionStorage[h]=0<e,angular.element(t).on("beforeunload",function(){delete sessionStorage[h]})}).$promise,g.then(function(){}).finally(function(){p.tabs="true"==sessionStorage[h]?{settlereport:"结算报表",monthlyreport:"月报表",dailyreport:"日报表",departmentreport:"商户报表"}:{settlereport:"结算报表",monthlyreport:"月报表",dailyreport:"日报表"},p.tabClick(s.tab||"settlereport")})}return p.filter=function(){p.gridOptions.enableFiltering=!p.gridOptions.enableFiltering,p.gridApi.core.notifyDataChange(d.dataChange.COLUMN)},p.export=function(){switch(p.tabActive){case"settlereport":case"monthlyreport":case"projectreport":p.gridOptions.exporterCsvFilename=document.title+"_统计_"+p.tabs[p.tabActive]+"_"+p.startDate.replace(/\-/g,"")+"_"+p.endDate.replace(/\-/g,"")+".csv";break;case"dailyreport":case"departmentreport":p.gridOptions.exporterCsvFilename=document.title+"_统计_"+p.tabs[p.tabActive]+"_"+p.startDate.replace(/\-/g,"")+".csv"}p.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},(p.grid_timetype=function(e){p.grid_timetype_current=e,p.rebuildData&&p.rebuildData(p.gridOptions.data)})("usage"),p.rebuildData=function(e){"monthlyreport"===p.tabActive&&angular.forEach(e,function(i){i.monthlySum=Math.round(100*i.monthlySum)/100,angular.forEach(i[p.grid_timetype_current],function(e,t){i["day"+n("date")(t,"yyyyMMdd")]=e})}),"dailyreport"===p.tabActive&&angular.forEach(e,function(i){i.dailysum=Math.round(100*i.dailysum)/100,angular.forEach(i[p.grid_timetype_current],function(e,t){i["hour"+n("date")(t,"H")]=e})}),p.gridOptions.data=e},m.$watch("$ctrl.billingserviceData.selected",function(e){angular.isDefined(e)&&(a.User.data.groupmode?p.tabClick("projectreport"):p.tabClick(s.tab||"settlereport"))}),p}]}),angular.module("app").filter("numberToFixed",function(){return function(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}});