angular.module("app").component("statistic",{templateUrl:"app/modules/statistic/statistic.html?rev=2658a9ef56",controller:["$templateCache","$api","$filter","$timeout","$stateParams","uiGridConstants",function(e,t,i,a,r,l){var n=this,s=new Date,d=APP.Project.current&&APP.Project.current._id;return n.groupmode=APP.User.groupmode,!n.groupmode&&t.energy.info({project:APP.Project.ids},function(e){angular.forEach(e.result.energy||{},function(e){this.push(e)},n.energyData=[])}),n.filter=function(){n.gridOptions.enableFiltering=!n.gridOptions.enableFiltering,n.gridApi.core.notifyDataChange(l.dataChange.COLUMN)},n.export=function(){switch(n.tabActive){case"settlereport":case"monthlyreport":case"projectreport":n.gridOptions.exporterCsvFilename=APP.title+"_统计_"+n.tabs[n.tabActive]+"_"+n.startDate.replace(/\-/g,"")+"_"+n.endDate.replace(/\-/g,"")+".csv";break;case"dailyreport":n.gridOptions.exporterCsvFilename=APP.title+"_统计_"+n.tabs[n.tabActive]+"_"+n.startDate.replace(/\-/g,"")+".csv"}n.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},(n.grid_timetype=function(e){n.grid_timetype_current=e,n.rebuildData&&n.rebuildData(n.gridOptions.data)})("usage"),n.rebuildData=function(e){"monthlyreport"===n.tabActive&&angular.forEach(e,function(e){e.monthlySum=Math.round(100*e.monthlySum)/100,angular.forEach(e[n.grid_timetype_current],function(t,a){e["day"+i("date")(a,"yyyyMMdd")]=t})}),"dailyreport"===n.tabActive&&angular.forEach(e,function(e){e.dailysum=Math.round(100*e.dailysum)/100,angular.forEach(e[n.grid_timetype_current],function(t,a){e["hour"+i("date")(a,"H")]=t})}),n.gridOptions.data=e},n.gridOptions={onRegisterApi:function(e){n.gridApi=e},rowHeight:34,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterHeaderFilter:function(e){return"能耗总值"===e?e+"(合计："+n.statistic.sum+")":"费用"===e?e+"(合计："+n.statistic.cost+")":e},exporterFieldCallback:function(e,t,i,a){return{name:!0,"id.substr(12,12)":!0,"channeldid.substr(12,12)":!0}[i.field]?'="'+(a||"")+'"':a}},n.tabs=n.groupmode?{projectreport:"项目总用能"}:{settlereport:"结算报表",monthlyreport:"月报表",dailyreport:"日报表"},n.tabClick=function(e){n.startDate=i("date")(s,"dailyreport"===e?"yyyy-MM-dd":"yyyy-MM-01"),n.endDate=i("date")(s,"yyyy-MM-dd"),n.rangeDay={settlereport:183,monthlyreport:31}[e]||0,n.tabActive=e,n.report(e)},n.report=function(a){var r=n.energyData&&n.energyData.selected&&n.energyData.selected.id,l=e.get("ui-grid/uiGridHeaderCell"),s={project:[]};switch(angular.forEach(APP.Project,function(e){s.project.push({id:e._id,energy:r||void 0})}),a){case"settlereport":case"monthlyreport":case"projectreport":s.from=n.startDate.replace(/\-/g,""),s.to=n.endDate.replace(/\-/g,"");break;case"dailyreport":s.time=n.startDate.replace(/\-/g,"")}switch(a){case"settlereport":n.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"传感器名称",name:"name",width:"*",minWidth:260},{displayName:moment(n.startDate).format("YYYY年M月D日"),name:"min",type:"number",width:"*",minWidth:80,headerCellClass:"text-right",cellClass:"text-right"},{displayName:moment(n.endDate).format("YYYY年M月D日"),name:"max",type:"number",width:"*",minWidth:80,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"能耗总值",name:"sum",type:"number",width:"*",minWidth:130,headerCellClass:"text-right",cellClass:"text-right",headerCellTemplate:function(){return l.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.$ctrl.statistic.sum}}</div></div><div role="button" tabindex="0"')}},{displayName:"单价",name:"price",type:"number",width:"*",minWidth:100,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"倍率系数",name:"comi",type:"number",width:"*",minWidth:100,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"费用",name:"cost",type:"number",width:"*",minWidth:130,headerCellClass:"text-right",cellClass:"text-right",headerCellTemplate:function(){return l.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.$ctrl.statistic.cost}}</div></div><div role="button" tabindex="0"')}}];break;case"monthlyreport":n.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"传感器名称",name:"name",width:"*",minWidth:180},{displayName:"月能耗",type:"number",name:"monthlySum",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"日平均",type:"number",name:"dailyAvg",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"}];break;case"dailyreport":n.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"传感器名称",name:"name",width:"*",minWidth:200},{displayName:"日能耗",type:"number",name:"dailysum",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"}];break;case"projectreport":n.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"name",width:"*",minWidth:260},{displayName:"总用能",type:"number",name:"consumption",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"总费用",type:"number",name:"cost",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单位用能",type:"number",name:"uaec",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单位电能",type:"number",name:"uaeec",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"}]}t.business[a](s,function(e){switch(a){case"settlereport":e=e.result[d]||{},n.statistic=e.statistic||{},e=e.detail||[],n.gridOptions.columnDefs.push({displayName:"设备ID",name:"id.substr(12,12)",type:"number",width:"*",minWidth:120},{displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100});break;case"monthlyreport":e=e.result[d]||[],e.length&&(angular.forEach(e[0].usage,function(e,t){this.push({displayName:i("date")(t,"M-d"),name:"day"+i("date")(t,"yyyyMMdd"),width:"*",minWidth:60,headerCellClass:"text-right",cellClass:"text-right"})},n.gridOptions.columnDefs),n.gridOptions.columnDefs.push({displayName:"设备ID",type:"number",name:"channeldid.substr(12,12)",width:"*",minWidth:120},{displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100}));break;case"dailyreport":e=e.result[d]||[],e.length&&angular.forEach(e[0].usage,function(e,t){t=i("date")(t,"H"),this.push({displayName:t+"时",name:"hour"+t,width:"*",minWidth:50,headerCellClass:"text-right",cellClass:"text-right"})},n.gridOptions.columnDefs),n.gridOptions.columnDefs.push({displayName:"设备ID",type:"number",name:"channeldid.substr(12,12)",width:"*",minWidth:120},{displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100});break;case"projectreport":angular.forEach(e.result,function(e){angular.forEach(e,function(t,i){e[i]="name"===i?t:Math.round(100*t)/100}),this.push(e)},e=[])}n.rebuildData(e)})},n.tabClick(n.groupmode?"projectreport":r.tab||"settlereport"),n}]});