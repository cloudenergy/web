angular.module("app").component("monitor",{templateUrl:"app/modules/monitor/monitor.html?rev=6c23f3c2d6",controller:["$scope","$element","$q","$api","$timeout","uiGridConstants",function(e,t,i,n,l,a){var r=this,o=APP.Project.current&&APP.Project.current._id;r.groupmode=APP.User.groupmode,r.date=moment().format("YYYY-MM"),r.groupmode&&t.find("select.form-control.select").select2({dropdownCssClass:"monitor-select2-dropdown-inverse"}).change(function(){r.level=this.value}),r.showException=!1,r.exceptionChange=function(){r.deviceType.select(r.deviceType.selected)},r.filter=function(){r.gridOptions.enableFiltering=!r.gridOptions.enableFiltering,r.gridApi.core.notifyDataChange(a.dataChange.COLUMN)},r.export=function(){r.groupmode?r.gridOptions.exporterCsvFilename=APP.title+"_监控_"+r.date.replace(/\-/g,"")+".csv":r.gridOptions.exporterCsvFilename=APP.title+"_监控_"+r.deviceType.selected.name+"_"+moment().format("YYYYMMDDHHmmss")+".csv",r.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},r.openModal=function(e){r.curve=e},r.gridOptions={onRegisterApi:function(t){t.infiniteScroll.on.needLoadMoreData(e,function(){var e=i.defer(),n=function(){e.resolve()},l=function(){t.infiniteScroll.dataLoaded(),e.reject()};return function(e){e?e.then(function(){t.infiniteScroll.saveScrollPercentage(),t.infiniteScroll.dataLoaded(!1,!0).then(n,l)},l):l()}(r.list(!0)),e.promise}),r.gridApi=t},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,n){return{name:!0,addr:!0,title:!0,time:!0}[i.field]?'="'+(n||"")+'"':n}},r.groupmode?r.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"name",width:"*",minWidth:260,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a target="_blank" ui-sref="dashboard.control({projectid:row.entity.id})" ng-bind="COL_FIELD"></a></div>'},{displayName:"单位面积能耗",type:"number",name:"uaec",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"节能等级",type:"number",name:"ecslevel",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"节能标准",name:"ecsdesc",width:"*",minWidth:150,headerCellClass:"text-right",cellClass:"text-right"}]:r.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"设备编号",type:"number",name:"gatewayid",width:"*",minWidth:100},{displayName:"设备标识",type:"number",name:"addr",width:"*",minWidth:120},{displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"设备名称",name:"title",width:"*",minWidth:300,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.$ctrl.openModal(row.entity)" ng-bind="COL_FIELD"></a></div>'},{displayName:"通道名称",name:"channel",width:"*",minWidth:150,enableColumnMenu:!1,enableSorting:!1},{displayName:"设备读数",name:"lastvalue",type:"number",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.$ctrl.openModal(row.entity)" ng-bind="COL_FIELD"></a></div>'},{displayName:"通讯时间",name:"time",width:"*",minWidth:200,headerCellClass:"text-right",cellClass:"text-right",cellTemplate:'<div class="ui-grid-cell-contents" ng-if="COL_FIELD">{{COL_FIELD*1|date:\'yyyy年M月dd日 H:mm:ss\'}}</div>'},{displayName:"状态",name:"status",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1,headerCellClass:"text-center",cellClass:"text-center",cellTemplate:function(){return['<div class="ui-grid-cell-contents">','<b ng-show="COL_FIELD===0" class="ng-hide" style="color:#16a085;">正常</b>','<b ng-show="COL_FIELD===1" class="ng-hide" style="color:#c0392b;">数据异常</b>','<b ng-show="COL_FIELD===2" class="ng-hide" style="color:#8e44ad;">通讯异常</b>',"</div>"].join("")}}],o?(n.device.type({project:o},function(e){r.deviceType=e.result,r.deviceType.length&&(r.deviceType.select=function(e){r.deviceType.selected=e,r.gridOptions.data=[],r.list()})(r.deviceType[0])}),e.$watch("$ctrl.customerSelected",function(){r.deviceType&&r.list()})):l(function(){r.list()}),r.list=function(e){if(!(e&&r.gridOptions.paging&&r.gridOptions.paging.count<=r.gridOptions.paging.pageindex*r.gridOptions.paging.pagesize))return r.groupmode?void n.business.projectdetail({time:moment(r.date).format("YYYYMM"),project:APP.Project.ids,level:r.level||void 0},function(e){angular.forEach(e=e.result,function(e,t){e.id=t,this.push(e)},e=[]),r.gridOptions.data=e}):n.business.monitor({devicetype:r.deviceType.selected.id,project:o,showexception:r.showException?1:0,mode:"CHANNEL",usesocity:r.customerSelected?1:void 0,socitynode:r.customerSelected,pageindex:(e&&r.gridOptions.paging?r.gridOptions.paging.pageindex:0)+1,pagesize:50},function(t){return t=t.result[o]||{},angular.forEach(t.detail,function(e){this.push(e)},t.detail=[]),e?r.gridOptions.data=r.gridOptions.data.concat(t.detail||[]):(r.gridOptions.data=t.detail||[],r.gridOptions.data.length&&l(function(){r.gridApi.core.scrollTo(r.gridOptions.data[0],r.gridOptions.columnDefs[0])})),r.gridOptions.paging=t.paging,t}).$promise}}]}),angular.module("app").component("channeldetail",{templateUrl:"app/modules/monitor/channedetail.html?rev=745c43959c",bindings:{curve:"<"},controller:["$element","$api","$timeout",function(e,t,i){var n=this,l=e.find(".modal-curve");l.on("shown.bs.modal",function(){i(n.buildLine)}).on("hidden.bs.modal",function(){delete n.curve,delete n.timeline}),n.$onChanges=function(e){e.curve.currentValue&&n.channeldetail(e.curve.currentValue)},n.date=moment().format("YYYY-MM-DD"),n.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},n.timetype_current="DAY",n.timetypeChange=function(t){n.timetype_current=t,e.find(".modal-curve input[datetimepicker]").data("DateTimePicker").format({DAY:"YYYY-MM-DD",WEEK:"YYYY-MM-DD",MONTH:"YYYY-MM",YEAR:"YYYY"}[t]).viewMode({DAY:"days",WEEK:"days",MONTH:"months",YEAR:"years"}[t]).defaultDate(n.date),n.channeldetail()},n.channeldetail=function(e){n.curve=e||n.curve||{},n.curve.type=n.curve.type||"diff",n.curve.categories=[],n.curve.diff=[],n.curve.scale=[],n.curve.enable=!1,t.business.channeldetail({id:n.curve.id,timeformat:n.timetype_current,from:n.date.replace(/-/g,""),to:n.date.replace(/-/g,"")},function(e){e.result&&(angular.forEach(e.result.detail,function(e){n.curve.categories.push(e.timepoint),n.curve.diff.push(e.value),n.curve.scale.push(e.total)}),n.curve.enable=!0,n.curve.start=e.result.start,n.curve.unit=e.result.unit,l.hasClass("in")?n.buildLine():l.modal("show"))})},n.lineType=function(e){n.curve.type=e,n.buildLine()},n.buildLine=function(){n.curve.enable&&(n.timeline={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:n.curve.categories,labels:{formatter:function(){return moment(this.value).format({DAY:"H",WEEK:"M-DD",MONTH:"M-DD",YEAR:"YYYY-MM"}[n.timetype_current])}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y:.2f} '+n.curve.unit+"</span>"},series:[{name:n.curve.title,data:n.curve[n.curve.type]}]})}}]});