angular.module("app").component("control",{templateUrl:"app/modules/control/control.html?rev=5249becf8e",controller:["$scope","$timeout","$api","SweetAlert",function(e,n,t,o){var i=this,a=APP.Project.current&&APP.Project.current._id;a&&t.device.type({project:a},function(e){i.deviceType=e.result,i.deviceType.length&&(i.deviceType.select=function(e){i.deviceType.selected=e,i.monitorData=[],i.list()})(i.deviceType[0])}),a&&t.customer.info({project:a,onlynode:1},function(e){i.customer={core:{data:[{id:"ROOT",parent:"#",text:"全部",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e,n){return"ROOT"===e.id?i.customer.selected=void 0:i.customer.selected=e.id,i.list(),!0},plugins:["search","conditionalselect"]},function e(n,t){angular.forEach(n,function(n,o){n.parent=t,n.text=n.title,Object.keys(n.child).length?n.icon="glyphicon glyphicon-th-list":n.icon="glyphicon glyphicon-file",e(n.child,n.id),i.customer.core.data.push(n)})}(e.result,"ROOT")}),i.paging={index:1,size:50,total:0,flow:function(e){50+e.target.offsetHeight+e.target.scrollTop>e.target.scrollHeight&&i.monitorData&&!i.monitorData.loading&&i.paging.total>i.paging.index*i.paging.size&&(i.paging.index+=1,i.list(!0))}},i.monitorData=[],i.list=function(e){i.deviceType.selected&&!i.monitorData.loading&&(!e&&angular.extend(i.paging,{index:1,total:0}),i.monitorData.loading=!0,t.business.monitor({devicetype:i.deviceType.selected.id,project:a,ext:{enableMask:1},mode:"SENSOR",usesocity:i.customer&&i.customer.selected?1:void 0,socitynode:i.customer&&i.customer.selected,pageindex:i.paging.index,pagesize:i.paging.size},function(n){n=n.result[a]||{},i.monitorData=e?i.monitorData.concat(n.detail):n.detail,i.paging.total=n.paging.count}))},i.modalSend=function(e){i.modalForm={sensorid:e.id}},i.modalReset=function(){delete i.modalForm.command,delete i.modalForm.data},i.sendCommand=function(){t.control.through(i.modalForm,function(e){!function(e,n){e?(angular.forEach({60000001:"发送超时",60000002:"发送超时",60000003:"发送超时"},function(t,o){parseInt(e)===parseInt(o)&&(n=t)}),n&&o.warning.apply(o,angular.isArray(n)?n:[n])):o.success("发送成功")}(e.code,e.message)})},$("#controlSendCommand").on("hidden.bs.modal",function(){return n(function(){delete i.modalForm,e.formSendCommand.$setPristine()}),!1}),$("#controlSendCommand input[name=command]").on("invalid",function(){return n(e.formSendCommand.command.$setDirty),!1}),$("#controlSendCommand input[name=data]").on("invalid",function(){return n(e.formSendCommand.data.$setDirty),!1})}]}),angular.module("app").directive("controlSlider",["$api","$timeout",function(e,n){return{restrict:"A",scope:{},template:function(){return['<div class="ui-slider"></div>','<div class="text-left" style="min-width:200px;line-height:24px;">','<span class="text-muted">范围：16 ~ 30<i class="emweb web-degree"></i></span>&nbsp;&nbsp;','<span class="text-primary">设定：{{value+15}}<i class="emweb web-degree"></i></span>',"</div>"].join("")},link:function(t,o,i,a){angular.isDefined(i.command)&&t.$watch(i.command,function(){var a=angular.extend({min:1,max:10,value:5,orientation:"horizontal",range:"min",change:function(n,t){a.value!==t.value&&(a.value=t.value,e.control.send({id:i.sensorid,command:i.command,param:{value:t.value+15}}))},slide:function(e,o){n(function(){t.value=o.value})}},o.data());a.value>a.max&&(a.value=Math.ceil(a.value%a.max)),t.value=a.value,o.children(".ui-slider").slider(a)})}}}]),angular.module("app").directive("controlMode",["$api",function(e){return{restrict:"A",scope:{},template:function(){return['<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===1}" ng-click="mode(1)"><i class="emweb web-snow"></i>制冷</a>','<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===2}" ng-click="mode(2)"><i class="emweb web-sun"></i>制热</a>','<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===3}" ng-click="mode(3)"><i class="emweb web-clear-wet"></i>除湿</a>','<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===4}" ng-click="mode(4)"><i class="emweb web-ventilation"></i>通风</a>'].join("")},link:function(n,t,o,i){angular.isUndefined(o.command)||n.$watch(o.command,function(){n.current={EMC_COOLING:1,EMC_HEATING:2,EMC_DEHUMIDIFYING:3,EMC_VERTILATING:4}[o.status]||0,n.mode=function(t){n.current=t,e.control.send({id:o.sensorid,command:o.command,param:{mode:{1:"EMC_COOLING",2:"EMC_HEATING",3:"EMC_DEHUMIDIFYING",4:"EMC_VERTILATING"}[t]}})}})}}}]),angular.module("app").directive("controlSpeed",["$api",function(e){return{restrict:"A",scope:{},template:function(){return['<i class="emweb web-speed-three" ng-class="{active:current===1}" ng-click="speed(1)"></i>','<i class="emweb web-speed-four" ng-class="{active:current===2}" ng-click="speed(2)"></i>','<i class="emweb web-speed-five" ng-class="{active:current===3}" ng-click="speed(3)"></i>'].join("")},link:function(n,t,o,i){angular.isUndefined(o.command)||n.$watch(o.command,function(){n.current={EMC_LOW:1,EMC_MEDIUM:2,EMC_HIGH:3}[o.status]||0,n.speed=function(t){n.current=t,e.control.send({id:o.sensorid,command:o.command,param:{mode:{1:"EMC_LOW",2:"EMC_MEDIUM",3:"EMC_HIGH"}[t]}})}})}}}]),angular.module("app").directive("controlSwitch",["$q","$api","$timeout","SweetAlert",function(e,n,t,o){return{restrict:"A",link:function(i,a,c,r){angular.isUndefined(c.ngChecked)?a.bootstrapSwitch():(a.bootstrapSwitch("disabled",!0),i.$watch(c.ngChecked,function(i){t(function(r){r=!0,c.command&&a.bootstrapSwitch("disabled",!1).bootstrapSwitch("state",i).on("switchChange.bootstrapSwitch",function(i,s){t(function(){/^(EMC_SWITCH)$/.test(c.command)?r&&o.swal({title:"控制校验",input:"password",cancelButtonText:"取消",confirmButtonText:"确定",inputPlaceholder:"控制密码",showCancelButton:!0,showLoaderOnConfirm:!0,allowOutsideClick:!1,preConfirm:function(t){var o=e.defer();return t?n.control.send({id:c.sensorid,command:c.command,param:{mode:s?c.onValue:c.offValue},ctrlcode:(new Hashes.SHA1).hex(t).toUpperCase()},function(e){e.code?o.reject("密码校验未通过"):o.resolve(e)}):o.reject("请输入控制密码"),o.promise}}).then(function(e){o.close()},function(e){r=!1,a.bootstrapSwitch("toggleState"),t(function(){r=!0})}):n.control.send({id:c.sensorid,command:c.command,param:{mode:s?c.onValue:c.offValue}})})})})}))}}}]);