angular.module("app").component("control",{templateUrl:"app/modules/control/control.html?rev=2fd9cfab1c",controller:["$scope","$element","$timeout","$api","$q","SweetAlert",function(e,n,t,a,i,o){var l=this,c=APP.Project.current&&APP.Project.current._id,r=function(e,n,t){if(angular.isObject(e)&&!angular.isArray(e)){var a=[],i=e.status[t];return angular.forEach(l.monitorData,function(e){e.checked&&e.command[n]&&(e.status[t]=i,a.push(e.id))}),a.length?(e.checked||(e.checked=!0,a.push(e.id)),l.multiCheck(),a):e.id}e=angular.isArray(e)?e:[e],angular.forEach(l.monitorData,function(n){~e.indexOf(n.id)&&(n.status[t]=void 0)})};l.multiCheck=function(e){"all"===e?angular.forEach(l.monitorData,function(e){e.checked=l.multiCheck.all}):(l.multiCheck.all=!0,angular.forEach(l.monitorData,function(e){e.checked||delete l.multiCheck.all}))},c&&a.device.type({project:c},function(e){l.deviceType=e.result,l.deviceType.length&&(l.deviceType.select=function(e){delete l.multiCheck.all,l.deviceType.selected=e,l.monitorData=[],l.list()})(l.deviceType[0])}),l.paging={index:1,size:50,total:0,flow:function(e){50+e.target.offsetHeight+e.target.scrollTop>e.target.scrollHeight&&l.monitorData&&!l.monitorData.loading&&l.paging.total>l.paging.index*l.paging.size&&(l.paging.index+=1,l.list(!0))}},l.monitorData=[],l.list=function(e){l.deviceType&&l.deviceType.selected&&!l.monitorData.loading&&(!e&&angular.extend(l.paging,{index:1,total:0}),l.monitorData.loading=!0,a.business.monitor({devicetype:l.deviceType.selected.id,project:c,key:l.searchKey,ext:{enableMask:1},mode:"SENSOR",usesocity:l.customerSelected?1:void 0,socitynode:l.customerSelected,pageindex:l.paging.index,pagesize:l.paging.size},function(n){n=n.result[c]||{},angular.forEach(n.detail,function(e){angular.forEach(e.command,function(n){e.command[n]=n})}),l.monitorData=e?l.monitorData.concat(n.detail||[]):n.detail||[],l.paging.total=n.paging.count,l.multiCheck.all&&l.multiCheck("all")}))},e.$watch("$ctrl.customerSelected",function(){l.list()}),l.confirmControl=function(e,n,t,l){var c=r(e,n,t),d={};d[l]=e.status[t],o.swal({title:"控制校验",input:"password",cancelButtonText:"取消",confirmButtonText:"确定",inputPlaceholder:"控制密码",showCancelButton:!0,showLoaderOnConfirm:!0,allowOutsideClick:!1,preConfirm:function(e){var t=i.defer();return e?a.control.send({id:c,command:n,param:d,ctrlcode:(new Hashes.SHA1).hex(e).toUpperCase()},function(e){e.code?t.reject("密码校验未通过"):t.resolve(e)}):t.reject("请输入控制密码"),t.promise}}).then(function(){o.close()},function(){r(c,n,t)})},l.multiControl=function(e,n,t,i){var l=r(e,n,t),c={};c[i]="EMC_TEMPERATURE"===n?e.status[t]+15:e.status[t],a.control.send({id:l,command:n,param:c},function(e){e.code&&(r(l,n,t),o.error("操作失败",e.message))})}}]}),angular.module("app").component("controlSlider",{templateUrl:"app/modules/control/slider.html?rev=a0d55c23f0",bindings:{value:"=",disabled:"<",onSlider:"&"},controller:["$scope","$element",function(e,n){var t=this,a=n.children(".ui-slider"),i=angular.extend({min:1,max:10,value:o,orientation:"horizontal",range:"min"},n.data()),o=5,l=!1,c=function(e,n){t.value!==n.value&&(l=!0,o=t.value,t.value=n.value)},r=function(n,a){t.uivalue=a.value,e.$apply()};i.disabled=angular.isUndefined(t.disabled)?i.disabled:t.disabled,angular.isUndefined(t.value)||(i.value=t.value),i.value>i.max&&(i.value=Math.ceil(i.value%i.max)),t.value=i.value,t.uivalue=i.value,a.slider(i),e.$watch("$ctrl.value",function(e){l?(l=!1,t.onSlider()):angular.isUndefined(e)?(t.value=o,t.uivalue=o):(a.off("slide"),a.off("slidechange"),a.slider("value",t.uivalue=e),a.on("slide",r),a.on("slidechange",c))})}]}),angular.module("app").component("controlSpeed",{template:'<i class="emweb" ng-repeat="(key,val) in $ctrl.items" ng-class="[val,{active:$ctrl.speed===key}]" ng-click="$ctrl.click(key)"></i>',bindings:{speed:"=",disabled:"<",onSpeed:"&"},controller:["$scope",function(e){var n=this,t=0,a=!1;n.items={EMC_LOW:"web-speed-three",EMC_MEDIUM:"web-speed-four",EMC_HIGH:"web-speed-five"},n.disabled||(n.click=function(e){a=!0,t=n.speed,n.speed=e},e.$watch("$ctrl.speed",function(e){a===!0?(a=!1,n.onSpeed()):angular.isUndefined(e)?n.speed=t:n.speed=e}))}]}),angular.module("app").component("controlMode",{template:'<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-repeat="(key,item) in $ctrl.items" ng-class="{active:$ctrl.current===key}" ng-click="$ctrl.click(key)"><i class="emweb" ng-class="item.icon"></i>{{item.name}}</a>',bindings:{mode:"=",disabled:"<",onMode:"&"},controller:["$scope",function(e){var n=this,t=0,a=!1;n.items={EMC_COOLING:{icon:"web-snow",name:"制冷"},EMC_HEATING:{icon:"web-sun",name:"制热"},EMC_DEHUMIDIFYING:{icon:"web-clear-wet",name:"除湿"},EMC_VERTILATING:{icon:"web-ventilation",name:"通风"}},n.disabled||(n.click=function(e){a=!0,t=n.mode,n.mode=e},e.$watch("$ctrl.mode",function(e){a===!0?(a=!1,n.onMode()):angular.isUndefined(e)?n.mode=t:n.mode=e}))}]}),angular.module("app").component("controlCommand",{templateUrl:"app/modules/control/command.html?rev=fa19bacbe1",bindings:{selected:"="},controller:["$scope","$element","$api","SweetAlert",function(e,n,t,a){var i,o=this,l=n.children(".modal");e.$watch("$ctrl.selected",function(n){n&&(o.formData={sensorid:n.id},l.modal("show"),i=e.form)}),o.submit=function(){t.control.through(o.formData,function(e){!function(e,n){e?(angular.forEach({60000001:"发送超时",60000002:"发送超时",60000003:"发送超时"},function(t,a){parseInt(e)===parseInt(a)&&(n=t)}),n&&a.warning.apply(a,angular.isArray(n)?n:[n])):a.success("发送成功")}(e.code,e.message)})},o.reset=function(){delete o.formData.command,delete o.formData.data},l.on("hidden.bs.modal",function(){return delete o.selected,delete o.formData,i.$setPristine(),e.$apply(),!1}),l.find("input[name=command]").on("invalid",function(){return i.command.$setDirty(),e.$apply(),!1}),l.find("input[name=data]").on("invalid",function(){return i.data.$setDirty(),e.$apply(),!1})}]});