angular.module("app").component("control",{templateUrl:"app/modules/control/control.html?rev=c9d3f659ff",controller:["$scope","$element","$timeout","$api","$q","SweetAlert",function(e,n,t,a,i,c){var o=this,r=APP.Project.current&&APP.Project.current._id;o.multiChecked={},o.checkedAll=function(){angular.forEach(o.monitorData,function(e){o.multiChecked[e.id]=o.multiChecked.all})},r&&a.device.type({project:r},function(e){o.deviceType=e.result,o.deviceType.length&&(o.deviceType.select=function(e){o.multiChecked={},o.deviceType.selected=e,o.monitorData=[],o.list()})(o.deviceType[0])}),o.paging={index:1,size:50,total:0,flow:function(e){50+e.target.offsetHeight+e.target.scrollTop>e.target.scrollHeight&&o.monitorData&&!o.monitorData.loading&&o.paging.total>o.paging.index*o.paging.size&&(o.paging.index+=1,o.list(!0))}},o.monitorData=[],o.list=function(e){o.deviceType&&o.deviceType.selected&&!o.monitorData.loading&&(!e&&angular.extend(o.paging,{index:1,total:0}),o.monitorData.loading=!0,a.business.monitor({devicetype:o.deviceType.selected.id,project:r,key:o.searchKey,ext:{enableMask:1},mode:"SENSOR",usesocity:o.customerSelected?1:void 0,socitynode:o.customerSelected,pageindex:o.paging.index,pagesize:o.paging.size},function(n){n=n.result[r]||{},angular.forEach(n.detail,function(e){o.multiChecked.all&&(o.multiChecked[e.id]=!0),angular.forEach(e.command,function(n){e.command[n]=n})}),o.monitorData=e?o.monitorData.concat(n.detail||[]):n.detail||[],o.paging.total=n.paging.count}))},e.$watch("$ctrl.customerSelected",function(){o.list()}),o.onSwitch=function(e,n,t,r,l){var s=[e.id],d=e.status[t],u=function(t){var c=i.defer();return a.control.send(angular.extend({id:s.length>1?s:e.id,command:n,param:{mode:d?r:l}},t||{}),function(e){e.code?c.reject(e):c.resolve(e)}),c.promise};angular.forEach(o.monitorData,function(a){o.multiChecked[a.id]===!0&&a.command[n]&&a.id!==e.id&&(a.status[t]=d,s.push(a.id))}),Object.keys(s).length>1&&(o.multiChecked[e.id]=!0),(e.command[n]?c.swal({title:"控制校验",input:"password",cancelButtonText:"取消",confirmButtonText:"确定",inputPlaceholder:"控制密码",showCancelButton:!0,showLoaderOnConfirm:!0,allowOutsideClick:!1,preConfirm:function(e){var n=i.defer();return e?u({ctrlcode:(new Hashes.SHA1).hex(e).toUpperCase()}).then(function(e){n.resolve(e)},function(){n.reject("密码校验未通过")}):n.reject("请输入控制密码"),n.promise}}):u()).then(function(){e.command[n]&&c.close()},function(){angular.forEach(o.monitorData,function(e){~s.indexOf(e.id)&&(e.status[t]=!d)}),!e.command[n]&&c.error("操作失败")})}}]}),angular.module("app").component("controlCommand",{templateUrl:"app/modules/control/command.html?rev=fa19bacbe1",bindings:{selected:"="},controller:["$scope","$element","$api","SweetAlert",function(e,n,t,a){var i,c=this,o=n.children(".modal");e.$watch("$ctrl.selected",function(n){n&&(c.formData={sensorid:n.id},o.modal("show"),i=e.form)}),c.submit=function(){t.control.through(c.formData,function(e){!function(e,n){e?(angular.forEach({60000001:"发送超时",60000002:"发送超时",60000003:"发送超时"},function(t,a){parseInt(e)===parseInt(a)&&(n=t)}),n&&a.warning.apply(a,angular.isArray(n)?n:[n])):a.success("发送成功")}(e.code,e.message)})},c.reset=function(){delete c.formData.command,delete c.formData.data},o.on("hidden.bs.modal",function(){return delete c.selected,delete c.formData,i.$setPristine(),e.$apply(),!1}),o.find("input[name=command]").on("invalid",function(){return i.command.$setDirty(),e.$apply(),!1}),o.find("input[name=data]").on("invalid",function(){return i.data.$setDirty(),e.$apply(),!1})}]}),angular.module("app").directive("controlSlider",["$api","$timeout",function(e,n){return{restrict:"A",scope:{},template:function(){return['<div class="ui-slider"></div>','<div class="text-left" style="min-width:200px;line-height:24px;">','<span class="text-muted">范围：16 ~ 30<i class="emweb web-degree"></i></span>&nbsp;&nbsp;','<span class="text-primary">设定：{{value+15}}<i class="emweb web-degree"></i></span>',"</div>"].join("")},link:function(t,a,i){angular.isDefined(i.command)&&t.$watch(i.command,function(){var c=angular.extend({min:1,max:10,value:5,orientation:"horizontal",range:"min",change:function(n,t){c.value!==t.value&&(c.value=t.value,e.control.send({id:i.sensorid,command:i.command,param:{value:t.value+15}}))},slide:function(e,a){n(function(){t.value=a.value})}},a.data());c.value>c.max&&(c.value=Math.ceil(c.value%c.max)),t.value=c.value,a.children(".ui-slider").slider(c)})}}}]),angular.module("app").directive("controlMode",["$api",function(e){return{restrict:"A",scope:{},template:function(){return['<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===1}" ng-click="mode(1)"><i class="emweb web-snow"></i>制冷</a>','<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===2}" ng-click="mode(2)"><i class="emweb web-sun"></i>制热</a>','<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===3}" ng-click="mode(3)"><i class="emweb web-clear-wet"></i>除湿</a>','<a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:current===4}" ng-click="mode(4)"><i class="emweb web-ventilation"></i>通风</a>'].join("")},link:function(n,t,a){angular.isUndefined(a.command)||n.$watch(a.command,function(){n.current={EMC_COOLING:1,EMC_HEATING:2,EMC_DEHUMIDIFYING:3,EMC_VERTILATING:4}[a.status]||0,n.mode=function(t){n.current=t,e.control.send({id:a.sensorid,command:a.command,param:{mode:{1:"EMC_COOLING",2:"EMC_HEATING",3:"EMC_DEHUMIDIFYING",4:"EMC_VERTILATING"}[t]}})}})}}}]),angular.module("app").directive("controlSpeed",["$api",function(e){return{restrict:"A",scope:{},template:function(){return['<i class="emweb web-speed-three" ng-class="{active:current===1}" ng-click="speed(1)"></i>','<i class="emweb web-speed-four" ng-class="{active:current===2}" ng-click="speed(2)"></i>','<i class="emweb web-speed-five" ng-class="{active:current===3}" ng-click="speed(3)"></i>'].join("")},link:function(n,t,a){angular.isUndefined(a.command)||n.$watch(a.command,function(){n.current={EMC_LOW:1,EMC_MEDIUM:2,EMC_HIGH:3}[a.status]||0,n.speed=function(t){n.current=t,e.control.send({id:a.sensorid,command:a.command,param:{mode:{1:"EMC_LOW",2:"EMC_MEDIUM",3:"EMC_HIGH"}[t]}})}})}}}]);