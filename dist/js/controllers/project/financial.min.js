EMAPP.templateCache.put("dist/html/project/financial/view.min.html?rev=951b2af9cd",'<div class="app-view-project-statistic"><p class="text-right text-info"><i class="em em-light"></i><small><strong>提示：</strong>可手动拖动调整列宽</small></p><div financial-main=""></div><div class="modal fade" id="financialModal" ng-if="self.tabActive!==\'deficit\'&&self.modalForm" financial-modal=""><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" ng-bind="self.modal.departmentname||self.modal.title||\'&nbsp;\'"></h4></div><div class="modal-body" ng-include="\'dist/html/project/financial/main.min.html?rev=73c897bdc2\'"></div></div></div></div></div>'),EMAPP.templateCache.put("dist/html/project/financial/main.min.html?rev=73c897bdc2",'<ul class="nav nav-tabs"><li ng-if="self.modal" class="active"><a href="javascript:void(0)" ng-bind="self.modal.modaltitle"></a></li><li ng-if="!self.modal" ng-repeat="(key,name) in self.tabs" ng-class="{active:self.tabActive===key}"><a ng-href="/dashboard/financial/{{key}}" ng-bind="name"></a></li><li class="pull-right form-inline"><div class="tool-group" ng-if="self.tabActive===\'nearest\'||self.tabActive===\'usage\'" ng-include="\'dist/html/project/financial/tool.min.html?rev=4c2328f0f2\'"></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.filter()">筛选<i class="em em-filter"></i></button></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.export()">导出<i class="em em-export-excel"></i></button></div></li></ul><div class="tab-content"><div class="tab-pane subContent active" financial-auto-height="" ui-i18n="\'zh-cn\'"><div ui-grid="self.gridOptions" class="grid" ui-grid-auto-resize="" ui-grid-exporter="" ui-grid-move-columns="" ui-grid-resize-columns="" ui-grid-infinite-scroll=""></div></div></div>'),EMAPP.templateCache.put("dist/html/project/financial/tool.min.html?rev=4c2328f0f2",'<div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" ng-model="self.fromDate" datetimepicker="" id="{{self.fromDate_ID}}"> <i class="em em-calendar form-control-feedback"></i></div><div class="input-group">至</div><div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" ng-model="self.toDate" datetimepicker="" id="{{self.toDate_ID}}"> <i class="em em-calendar form-control-feedback"></i></div><div class="input-group" ng-if="self.tabActive===\'nearest\'"><div class="btn-group btn-group-sm"><button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><span ng-bind="self.status.selected.title||\'全部\'">全部</span> <span class="caret"></span></button><ul class="dropdown-menu"><li ng-repeat="item in self.status" ng-class="{active:self.status.selected.id===item.id}" ng-click="self.status.selected=item;self.tabList();"><a href="javascript:void(0)" ng-bind="item.title"></a></li></ul></div></div>'),EMAPP.register.directive("financialModal",function(){return{restrict:"A",scope:!1,controller:"project.financial.modal",controllerAs:"self",link:function(e,t,i,a){e.self.modal=e.$parent.self.modalForm,e.self.tabActive=e.self.modal.tab,t.on("shown.bs.modal",function(t){e.self.tabList()}).on("hidden.bs.modal",function(t){delete e.self.modal,delete e.$parent.self.modalForm})}}}),EMAPP.register.directive("financialMain",function(){return{restrict:"A",templateUrl:"dist/html/project/financial/main.min.html?rev=73c897bdc2",controller:"project.financial",controllerAs:"self"}}),EMAPP.register.directive("financialAutoHeight",function(){return{restrict:"A",link:function(e,t,i,a){var n=function(){t.height($(window).height()-(e.self.modal?160:t.offset().top)-17)};n(),$(window).bind("resize",n),e.$on("$destroy",function(){$(window).unbind("resize",n)})}}}),function(){function e(e,t){var i,a,n=[],d="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");if(t=t||d.length,e)for(i=0;e>i;i++)n[i]=d[0|Math.random()*t];else for(n[8]=n[13]=n[18]=n[23]="-",n[14]="4",i=0;36>i;i++)n[i]||(a=0|16*Math.random(),n[i]=d[19==i?3&a|8:a]);return n.join("")}function t(t,i,a,n,d,l){var r=this,o=new Date;return r.tabs={nearest:"最近充值",deficit:"欠费商户",all:"全部商户"},r.tabActive=t.tab||"nearest",r.fromDate_ID="form_"+e(8),r.fromDate=n("date")(o,"yyyy-MM-01"),r.toDate_ID="to_"+e(8),r.toDate=n("date")(o,"yyyy-MM-dd"),d(function(e,t,i,a){e=$("#"+r.fromDate_ID),t=$("#"+r.toDate_ID),i=function(e){e.date&&e.oldDate&&d(r.tabList),a()},a=function(){e.data("DateTimePicker")&&e.data("DateTimePicker").maxDate(new Date(r.toDate.replace(/-/g,"/"))),t.data("DateTimePicker")&&t.data("DateTimePicker").minDate(new Date(r.fromDate.replace(/-/g,"/")))},e.on("dp.show",a),e.on("dp.change",i),t.on("dp.show",a),t.on("dp.change",i)}),r.status=[{id:0,title:"全部",val:void 0},{id:1,title:"自助充值",val:0},{id:2,title:"人工充值",val:1}],r.status.selected=r.status[0],r.filter=function(){r.gridOptions.enableFiltering=!r.gridOptions.enableFiltering,r.gridApi.core.notifyDataChange(l.dataChange.COLUMN)},r["export"]=function(){var e=n("date")(new Date,"yyyyMMdd_HHmmss");"nearest"===r.tabActive&&(e=[r.fromDate.replace(/-/g,""),r.toDate.replace(/-/g,"")].join("_")),r.gridOptions.exporterCsvFilename=r.tabActive+"_"+e+".csv",r.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},r.reminder=function(e){a.message.arreargereminder({uid:e.departmentaccount,project:EMAPP.Project.current._id,gateway:"EMAIL"},function(){e.remindercount+=1})},r.openModel=function(e,t,i){r.modalForm=e,r.modalForm.tab=t,r.modalForm.modaltitle=i},r.gridOptions={infiniteScrollDown:!0,onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(i,function(){return!e.loadPromise&&(e.loadPromise=r.load[r.tabActive](!0))?(e.loadPromise.then(function(){return e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(function(){return delete e.loadPromise})}),e.loadPromise):void 0}),r.gridApi=e},enableColumnResizing:!0,exporterOlderExcelCompatibility:!0},r.load={nearest:function(e){return r.gridOptions.paging&&r.gridOptions.paging.count<=r.gridOptions.paging.pageindex*r.gridOptions.paging.pagesize?void 0:a.business.recentchargelog({from:r.fromDate.replace(/-/g,""),to:r.toDate.replace(/-/g,""),pageindex:(r.gridOptions.paging?r.gridOptions.paging.pageindex:0)+1,pagesize:100,project:[{id:EMAPP.Project.current._id,ismanual:r.status.selected.val,department:r.modal?r.modal.departmentaccount||r.modal.account:void 0}]},function(t){return t=t.result[EMAPP.Project.current._id]||{},e?r.gridOptions.data=r.gridOptions.data.concat(t.detail.detail||[]):r.gridOptions.data=t.detail.detail||[],angular.forEach(r.gridOptions.data,function(e){angular.isUndefined(e.status)||(e.status=e.status?"完成":"未完成"),angular.isUndefined(e.timepaid)||(e.timepaid=e.timepaid?n("date")(1e3*e.timepaid,"yyyy-MM-dd HH:mm:ss"):""),angular.isUndefined(e.timecreate)||(e.timecreate=e.timecreate?n("date")(1e3*e.timecreate,"yyyy-MM-dd HH:mm:ss"):"")}),r.gridOptions.paging=t.paging,t}).$promise},deficit:function(e){return r.load.departments(e)},all:function(e){return r.load.departments(e)},departments:function(e){return r.gridOptions.paging&&r.gridOptions.paging.count<=r.gridOptions.paging.pageindex*r.gridOptions.paging.pagesize?void 0:a.business.departments({project:EMAPP.Project.current._id,amount:"all"===r.tabActive?void 0:0,pageindex:(r.gridOptions.paging?r.gridOptions.paging.pageindex:0)+1,pagesize:100},function(t){return t=t.result[EMAPP.Project.current._id]||{},e?r.gridOptions.data=r.gridOptions.data.concat(t.detail||[]):r.gridOptions.data=t.detail||[],angular.forEach(r.gridOptions.data,function(e){angular.isUndefined(e.arrearagetime)||(e.arrearagetime=e.arrearagetime?n("date")(1e3*e.arrearagetime,"yyyy-MM-dd HH:mm:ss"):"")}),r.gridOptions.paging=t.paging,t}).$promise},usage:function(e){return r.gridOptions.paging&&r.gridOptions.paging.count<=r.gridOptions.paging.pageindex*r.gridOptions.paging.pagesize?void 0:a.business.departmentusage({from:r.fromDate.replace(/-/g,""),to:r.toDate.replace(/-/g,""),pageindex:(r.gridOptions.paging?r.gridOptions.paging.pageindex:0)+1,pagesize:100,project:[{id:EMAPP.Project.current._id,account:r.modal?r.modal.departmentaccount||r.modal.account:void 0}]},function(t){return t=t.result[EMAPP.Project.current._id]||{},e?r.gridOptions.data=r.gridOptions.data.concat(t.detail||[]):r.gridOptions.data=t.detail||[],angular.forEach(r.gridOptions.data,function(e){angular.isUndefined(e.timepoint)||(e.timepoint=e.timepoint?n("date")(1e3*e.timepoint,"yyyy-MM-dd HH:mm:ss"):"")}),r.gridOptions.paging=t.paging,t}).$promise}},r.tabList=function(){switch(r.tabActive){case"nearest":r.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"title",width:"*",minWidth:120,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" data-toggle="modal" data-target="#financialModal" ng-click="grid.appScope.self.openModel(row.entity,\'nearest\',\'充值记录\')">{{COL_FIELD}}</a></div>'},{displayName:"商户账号",name:"account",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"充值金额(元)",name:"amount",width:"*",minWidth:120},{displayName:"本次余额(元)",name:"balance",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"充值方式",name:"channel",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"充值时间",name:"timepaid",type:"date",width:"*",minWidth:150},{displayName:"订单状态",name:"status",width:"*",minWidth:100,headerCellClass:"text-center",cellClass:"text-center"},{displayName:"订单时间",name:"timecreate",type:"date",width:"*",minWidth:150},{displayName:"操作账号",name:"operator",width:"*",minWidth:120,enableColumnMenu:!1}],r.modal&&r.gridOptions.columnDefs.splice(1,3);break;case"deficit":r.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"departmentname",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"商户账号",name:"departmentaccount",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"欠费金额(元)",name:"amount",width:"*",minWidth:120},{displayName:"欠费时间",name:"arrearagetime",type:"date",width:"*",minWidth:150},{displayName:"已催次数",name:"remindercount",width:100,minWidth:100},{displayName:"",name:"send",width:100,minWidth:100,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">催缴通知</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" class="btn btn-xs btn-info" ng-click="grid.appScope.self.reminder(row.entity)">催缴欠费</a></div>'}];break;case"all":r.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"商户名称",name:"departmentname",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"商户账号",name:"departmentaccount",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"联系电话",name:"mobile",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"商户余额(元)",name:"amount",width:"*",minWidth:120},{displayName:"",name:"nearest",width:100,minWidth:100,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">充值记录</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" data-toggle="modal" data-target="#financialModal" ng-click="grid.appScope.self.openModel(row.entity,\'nearest\',\'充值记录\')">充值记录</a></div>'},{displayName:"",name:"usage",width:100,minWidth:100,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">消费清单</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" data-toggle="modal" data-target="#financialModal" ng-click="grid.appScope.self.openModel(row.entity,\'usage\',\'消费清单\')">消费清单</a></div>'}];break;case"usage":r.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"消费金额(元)",name:"cost",width:"*",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:150}]}r.load[r.tabActive]&&r.load[r.tabActive]()},!t.modal&&r.tabList(),r}EMAPP.register.controller("project.financial",["$stateParams","$scope","$api","$filter","$timeout","uiGridConstants",t]),EMAPP.register.controller("project.financial.modal",["$stateParams","$scope","$api","$filter","$timeout","uiGridConstants",function(){arguments[0].modal=!0,t.apply(this,arguments)}])}();