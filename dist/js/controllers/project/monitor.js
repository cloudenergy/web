EMAPP.templateCache.put("dist/html/project/monitor.html?rev=dc9d875f54",'<div class="app-view-project-monitor text-center ng-cloak"><div class="nav nav-tabs"><div ng-if="!self.groupmode" class="btn-group"><a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:self.deviceType.selected.id===item.id}" ng-repeat="item in self.deviceType" ng-click="self.deviceType.select(item)" ng-bind="item.name"></a></div><div class="pull-right form-inline"><div ng-if="!self.groupmode" class="btn-group"><b style="vertical-align:middle">æ ‘å½¢åˆ—è¡¨ï¼š</b> <input type="checkbox" flatui-switch flatui-switch-change="self.customerChange" ng-checked="self.showCustomer" data-toggle="switch" data-on-color="info" data-off-color="primary" data-on-text="æ˜¾ç¤º" data-off-text="éšè—"></div><div ng-if="!self.groupmode" class="btn-group"><b style="vertical-align:middle">çŠ¶æ€ï¼š</b><div class="bootstrap-switch-square"><input type="checkbox" flatui-switch flatui-switch-change="self.exceptionChange" ng-checked="self.showException" data-toggle="switch" data-on-color="warning" data-off-color="primary" data-on-text="å¼‚å¸¸" data-off-text="æ­£å¸¸"></div></div><div ng-show="self.groupmode" class="form-group form-group-sm has-feedback date ng-hide"><input type="text" class="form-control" id="calendar" ng-model="self.date" data-format="YYYY-MM" datetimepicker> <i class="form-control-feedback emweb web-calendar"></i></div><div ng-if="self.groupmode" class="form-group form-group-sm"><select class="form-control select select-primary select-block" monitor-select><option value="">å…¨éƒ¨</option><option value="1">0-1.8 KWh</option><option value="2">1.8-3.8 KWh</option><option value="3">3.8-5.7 KWh</option><option value="4">5.7-7.7 KWh</option><option value="5">7.7-âˆ KWh</option></select></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.filter()">ç­›é€‰<i class="emweb web-filter"></i></button></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.export()">å¯¼å‡º<i class="emweb web-export-excel"></i></button></div></div></div><div class="tab-content row"><div class="tab-pane active" ng-class="{true:\'col-xs-10\',false:\'col-xs-12\'}[!!self.showCustomer]" auto-height ui-i18n="\'zh-cn\'"><div ui-grid="self.gridOptions" class="grid text-left" ui-grid-exporter ui-grid-auto-resize ui-grid-move-columns ui-grid-resize-columns ui-grid-infinite-scroll></div></div><div class="tab-pane col-xs-2 text-left" ng-class="{active:self.showCustomer}" style="padding-left:0"><input type="text" class="form-control input-sm" placeholder="ğŸ”å…³é”®å­—æœç´¢" ng-model="self.customer.search"><div auto-height jstree="self.customer" jstree-search="self.customer.search" style="overflow:auto"></div></div></div><div class="modal fade" id="curveModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" ng-bind="self.curveModal.title"></h4></div><div class="modal-body"><div class="form-inline text-right"><div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" id="modalCalendar" ng-model="self.date" datetimepicker> <i class="form-control-feedback emweb web-calendar"></i></div><div class="btn-group btn-group-sm"><a class="btn btn-primary" href="javascript:void(0)" ng-repeat="(key,val) in self.timetype" ng-class="{active:self.timetype_current===key}" ng-click="self.timetypeChange(key)" ng-bind="val"></a></div><div class="btn-group btn-group-sm"><a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.curveModal.type===\'diff\'}" ng-click="self.lineType(\'diff\');">å·®å€¼ <i class="emweb web-curve-area"></i> </a><a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.curveModal.type===\'scale\'}" ng-click="self.lineType(\'scale\');">åˆ»åº¦ <i class="emweb web-line-spacing"></i></a></div></div><div class="panel-body text-center"><div class="highcharts-panel" highcharts="self.timeline"></div></div></div></div></div></div></div>'),EMAPP.register.controller("project.monitor",["$scope","$q","$api","$filter","$timeout","uiGridConstants",function(e,t,i,n,l,a){var o=this,d=EMAPP.Project.current&&EMAPP.Project.current._id,r=new Date,s=$("#curveModal"),c=$("#calendar"),p=$("#modalCalendar");return o.groupmode=EMAPP.User.groupmode,o.groupmode||(o.showCustomer=1,o.customerChange=function(e,t){o.showCustomer=t,o.gridOptions.data=[],o.list()}),o.showException=0,o.exceptionChange=function(e,t){o.showException=t,o.deviceType.select(o.deviceType.selected)},o.filter=function(){o.gridOptions.enableFiltering=!o.gridOptions.enableFiltering,o.gridApi.core.notifyDataChange(a.dataChange.COLUMN)},o["export"]=function(){o.groupmode?o.gridOptions.exporterCsvFilename=EMAPP.title+"_ç›‘æ§_"+o.date.replace(/\-/g,"")+".csv":o.gridOptions.exporterCsvFilename=EMAPP.title+"_ç›‘æ§_"+o.deviceType.selected.name+"_"+n("date")(r,"yyyyMMddHHmmss")+".csv",o.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},o.gridOptions={onRegisterApi:function(i){i.infiniteScroll.on.needLoadMoreData(e,function(){var e=t.defer(),n=function(){e.resolve()},l=function(){i.infiniteScroll.dataLoaded(),e.reject()};return function(e){e?e.then(function(){i.infiniteScroll.saveScrollPercentage(),i.infiniteScroll.dataLoaded(!1,!0).then(n,l)},l):l()}(o.list(!0)),e.promise}),o.gridApi=i},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,n){return{name:!0,addr:!0,title:!0,time:!0}[i.field]?'="'+(n||"")+'"':n}},o.groupmode?(o.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">åºå·</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"é¡¹ç›®åç§°",name:"name",width:"*",minWidth:260,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a target="_blank" ng-href="/dashboard{{row.entity.id}}/control" ng-bind="COL_FIELD"></a></div>'},{displayName:"å•ä½é¢ç§¯èƒ½è€—",name:"uaec",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"èŠ‚èƒ½ç­‰çº§",name:"ecslevel",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"èŠ‚èƒ½æ ‡å‡†",name:"ecsdesc",width:"*",minWidth:150,headerCellClass:"text-right",cellClass:"text-right"}],l(function(){o.list()})):o.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">åºå·</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"é‡‡é›†å™¨ç¼–å·",name:"gatewayid",width:"*",minWidth:100},{displayName:"è®¾å¤‡ç¼–ç ",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"è®¾å¤‡åç§°",name:"title",width:"*",minWidth:260,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.self.channeldetail(grid.appScope.self.curveModal=row.entity)" ng-bind="COL_FIELD"></a></div>'},{displayName:"é€šé“åç§°",name:"channel",width:"*",minWidth:150,enableColumnMenu:!1,enableSorting:!1},{displayName:"èƒ½è€—åˆ†ç±»",name:"energycategory",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1},{displayName:"è®¾å¤‡è¯»æ•°",name:"lastvalue",width:"*",minWidth:120,headerCellClass:"text-right",cellClass:"text-right",cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-click="grid.appScope.self.channeldetail(grid.appScope.self.curveModal=row.entity)" ng-bind="COL_FIELD"></a></div>'},{displayName:"é€šè®¯æ—¶é—´",name:"time",width:"*",minWidth:200,headerCellClass:"text-right",cellClass:"text-right",cellTemplate:'<div class="ui-grid-cell-contents" ng-if="COL_FIELD">{{COL_FIELD*1|date:\'yyyyå¹´Mæœˆddæ—¥ H:mm:ss\'}}</div>'},{displayName:"çŠ¶æ€",name:"status",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1,headerCellClass:"text-center",cellClass:"text-center",cellTemplate:function(){return['<div class="ui-grid-cell-contents">','<b ng-show="COL_FIELD===0" class="ng-hide" style="color:#16a085;">æ­£å¸¸</b>','<b ng-show="COL_FIELD===1" class="ng-hide" style="color:#c0392b;">æ•°æ®å¼‚å¸¸</b>','<b ng-show="COL_FIELD===2" class="ng-hide" style="color:#8e44ad;">é€šè®¯å¼‚å¸¸</b>',"</div>"].join("")}}],d&&i.device.type({project:d},function(e){o.deviceType=e.result,o.deviceType.length&&(o.deviceType.select=function(e){o.deviceType.selected=e,o.list()})(o.deviceType[0])}),d&&i.customer.info({project:d,onlynode:1},function(e){o.customer={core:{data:[]},conditionalselect:function(e,t){return"root"===e.id?o.customer.selected=void 0:o.customer.selected=e.id,o.list(),!0},plugins:["search","conditionalselect"]},function t(e,i){angular.forEach(e,function(e,n){e.parent=i,e.text=e.title,"#"===i&&0===n&&(e.state={selected:!0,opened:!0}),Object.keys(e.child).length?e.icon="glyphicon glyphicon-th-list":e.icon="glyphicon glyphicon-file",t(e.child,e.id),o.customer.core.data.push(e)})}(e.result,"#")}),o.list=function(e){return e&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize?void 0:o.groupmode?void i.business.projectdetail({time:n("date")(o.date,"yyyyMM"),project:EMAPP.Project.ids,level:o.level||void 0},function(e){angular.forEach(e=e.result,function(e,t){e.id=t,this.push(e)},e=[]),o.gridOptions.data=e}):i.business.monitor({devicetype:o.deviceType.selected.id,project:d,showexception:o.showException?1:0,mode:"CHANNEL",usesocity:o.showCustomer||void 0,socitynode:o.showCustomer&&o.customer&&o.customer.selected||void 0,pageindex:(e&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:100},function(t){return t=t.result[d]||{},angular.forEach(t.detail,function(e){this.push(e)},t.detail=[]),e?o.gridOptions.data=o.gridOptions.data.concat(t.detail||[]):(o.gridOptions.data=t.detail||[],o.gridOptions.data.length&&l(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])})),o.gridOptions.paging=t.paging,t}).$promise},s.bind("shown.bs.modal",function(){l(o.buildLine)}).bind("hidden.bs.modal",function(){delete o.curveModal,delete o.timeline}),o.date=n("date")(r,o.groupmode?"yyyy-MM":"yyyy-MM-dd"),c.bind("dp.change",function(e){e.oldDate&&l(o.list)}),p.bind("dp.change",function(e){e.oldDate&&l(o.channeldetail)}),o.timetype={DAY:"æ—¥",WEEK:"å‘¨",MONTH:"æœˆ",YEAR:"å¹´"},o.timetype_current="DAY",o.timetypeChange=function(e){o.timetype_current=e,p.data("DateTimePicker").format({DAY:"YYYY-MM-DD",WEEK:"YYYY-MM-DD",MONTH:"YYYY-MM",YEAR:"YYYY"}[e]).viewMode({DAY:"days",WEEK:"days",MONTH:"months",YEAR:"years"}[e]).defaultDate(o.date),o.channeldetail()},o.lineType=function(e){o.curveModal.type=e,o.buildLine()},o.buildLine=function(){o.curveModal.enable&&(o.timeline={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:o.curveModal.categories,labels:{formatter:function(){return n("date")(this.value,{DAY:"H",WEEK:"M-dd",MONTH:"M-dd",YEAR:"yyyy-MM"}[o.timetype_current])}}},yAxis:{title:!1},tooltip:{xDateFormat:"%mæœˆ%dæ—¥",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y:.2f} '+o.curveModal.unit+"</span>"},series:[{name:o.curveModal.title,data:o.curveModal[o.curveModal.type]}]})},o.channeldetail=function(){o.curveModal.type=o.curveModal.type||"diff",o.curveModal.categories=[],o.curveModal.diff=[],o.curveModal.scale=[],o.curveModal.enable=!1,i.business.channeldetail({id:o.curveModal.id,timeformat:o.timetype_current,from:o.date.replace(/-/g,""),to:o.date.replace(/-/g,"")},function(e){e.result&&(angular.forEach(e.result.detail,function(e){o.curveModal.categories.push(e.timepoint),o.curveModal.diff.push(e.value),o.curveModal.scale.push(e.total)}),o.curveModal.enable=!0,o.curveModal.start=e.result.start,o.curveModal.unit=e.result.unit,s.hasClass("in")?o.buildLine():s.modal("show"))})},o}]);