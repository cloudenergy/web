EMAPP.templateCache.put("dist/html/project/monitor.min.html?rev=cbc0d84288",'<div class="app-view-project-monitor text-center ng-cloak"><div class="nav nav-tabs"><div ng-if="!self.groupuser" class="btn-group"><a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:self.energyData.selected.id===item.id}" ng-repeat="item in self.energyData" ng-click="self.energyData.select(item)" ng-bind="item.title"></a></div><div class="pull-right form-inline"><div ng-if="!self.groupuser" class="btn-group"><b>状态切换：</b><div class="bootstrap-switch-square"><input type="checkbox" monitor-switch checked="checked" data-toggle="switch" data-on-color="primary" data-off-color="warning" data-on-text="正常" data-off-text="异常"></div></div><div ng-if="self.groupuser" class="form-group form-group-sm"><select class="form-control select select-primary select-block" monitor-select><option value="">全部</option><option value="1">0-1.8 KWh</option><option value="2">1.8-3.8 KWh</option><option value="3">3.8-5.7 KWh</option><option value="4">5.7-7.7 KWh</option><option value="5">7.7-∞ KWh</option></select></div><div ng-show="self.groupuser" class="form-group form-group-sm has-feedback date ng-hide"><input type="text" class="form-control" id="calendar" ng-model="self.date" data-format="YYYY-MM" datetimepicker> <i class="form-control-feedback em em-calendar"></i></div></div></div><div class="tab-content"><div class="tab-pane subContent active" monitor-auto-height ui-i18n="\'zh-cn\'"><div ui-grid="self.gridOptions" class="grid" ui-grid-selection ui-grid-auto-resize ui-grid-move-columns ui-grid-resize-columns ui-grid-infinite-scroll></div></div></div><div class="modal fade" id="curveModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" ng-bind="self.curveModal.title"></h4></div><div class="modal-body"><div class="form-inline text-right"><div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" id="modalCalendar" ng-model="self.date" datetimepicker> <i class="form-control-feedback em em-calendar"></i></div><div class="btn-group btn-group-sm"><a class="btn btn-primary" href="javascript:void(0)" ng-repeat="(key,val) in self.timetype" ng-class="{active:self.timetype_current===key}" ng-click="self.timetypeChange(key)" ng-bind="val"></a></div><div class="btn-group btn-group-sm"><a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.curveModal.type===\'diff\'}" ng-click="self.lineType(\'diff\');">差值 <i class="em em-curve-area"></i></a> <a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.curveModal.type===\'scale\'}" ng-click="self.lineType(\'scale\');">刻度 <i class="em em-line-spacing"></i></a></div></div><div class="panel-body text-center"><div class="highcharts-panel" highcharts="self.timeline"></div></div></div></div></div></div></div>'),EMAPP.register.directive("monitorAutoHeight",function(){return{restrict:"A",link:function(e,t,i,n){var a=function(){t.height($(window).height()-130)};a(),$(window).bind("resize",a),e.$on("$destroy",function(){$(window).unbind("resize",a)})}}}),EMAPP.register.directive("monitorSwitch",["$timeout",function(e){return{restrict:"A",link:function(t,i,n,a){i.bootstrapSwitch().bind("switchChange.bootstrapSwitch",function(i,n){t.self.energyData&&e(function(){t.self.showException=n?0:1,t.self.energyData.select(t.self.energyData.selected)})})}}}]),EMAPP.register.directive("monitorSelect",function(){return{restrict:"A",link:function(e,t,i,n){t.select2({dropdownCssClass:"monitor-select2-dropdown-inverse"}).change(function(){e.self.level=this.value,e.self.list()})}}}),EMAPP.register.controller("project.monitor",["$scope","$q","$api","$filter","$timeout","$state","uiGridConstants",function(e,t,i,n,a,o,r){var l=this,d=EMAPP.Project.current&&EMAPP.Project.current._id,s=new Date,c=($("#showException"),$("#curveModal")),u=$("#calendar"),p=$("#modalCalendar");return l.groupuser=EMAPP.User.groupuser,l.showException=0,l.gridOptions={onRegisterApi:function(i){i.infiniteScroll.on.needLoadMoreData(e,function(){var e=t.defer(),n=function(){e.resolve()},a=function(){i.infiniteScroll.dataLoaded(),e.reject()};return function(e){e?e.then(function(){i.infiniteScroll.saveScrollPercentage(),i.infiniteScroll.dataLoaded(!1,!0).then(n,a)},a):a()}(l.list(!0)),e.promise}),i.selection.on.rowSelectionChanged(e,function(e){l.groupuser?o.go("dashboard.control",{projectid:e.entity.id}):l.channeldetail(l.curveModal=e.entity)}),l.gridApi=i},infiniteScrollDown:!0,enableColumnResizing:!0,enableRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!1,modifierKeysToMultiSelect:!1,noUnselect:!0},l.groupuser?(l.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"name",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents"><a href="javascript:void(0)" ng-bind="COL_FIELD"></a></div>'},{displayName:"单位面积能耗",name:"uaec",width:"*",minWidth:120},{displayName:"节能等级",name:"ecslevel",width:"*",minWidth:120},{displayName:"节能标准",name:"ecsdesc",width:"*",minWidth:150}],a(function(){l.list()})):l.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"设备标识",name:"addr",width:"*",minWidth:120},{displayName:"设备名称",name:"title",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1},{displayName:"通道名称",name:"channel",width:"*",minWidth:150,enableColumnMenu:!1,enableSorting:!1},{displayName:"能耗分类",name:"energycategory",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1},{displayName:"设备读数",name:"lastvalue",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1},{displayName:"通讯时间",name:"time",width:"*",minWidth:120,cellTemplate:'<div class="ui-grid-cell-contents" ng-if="COL_FIELD">{{COL_FIELD*1|date:\'yyyy/MM/dd HH:mm:ss\'}}</div>'},{displayName:"状态",name:"status",width:"*",minWidth:120,enableColumnMenu:!1,enableSorting:!1,headerCellClass:"text-center",cellClass:"text-center",cellTemplate:function(){return['<div class="ui-grid-cell-contents">','<b ng-show="COL_FIELD===0" class="ng-hide" style="color:#16a085;">正常</b>','<b ng-show="COL_FIELD===1" class="ng-hide" style="color:#c0392b;">数据异常</b>','<b ng-show="COL_FIELD===2" class="ng-hide" style="color:#8e44ad;">通讯异常</b>',"</div>"].join("")}}],d&&i.energy.info({project:d},function(e){angular.forEach(e.result.energy||{},function(e){this.push(e)},l.energyData=[]),(l.energyData.select=function(e){l.energyData.selected=e,l.list()})(l.energyData[0])}),l.list=function(e){return e&&l.gridOptions.paging&&l.gridOptions.paging.count<=l.gridOptions.paging.pageindex*l.gridOptions.paging.pagesize?void 0:l.groupuser?i.business.projectdetail({time:n("date")(l.date,"yyyyMM"),project:EMAPP.Project.ids,level:l.level||void 0},function(t){return angular.forEach(t=t.result,function(e,t){e.id=t,this.push(e)},t=[]),e?l.gridOptions.data=l.gridOptions.data.concat(t):(l.gridOptions.data=t,l.gridOptions.data.length&&a(function(){l.gridApi.core.scrollTo(l.gridOptions.data[0],l.gridOptions.columnDefs[0])})),l.gridOptions.paging=t.paging,t}).$promise:i.business.monitor({energytype:l.energyData.selected.id,project:d,showexception:l.showException,pageindex:(e&&l.gridOptions.paging?l.gridOptions.paging.pageindex:0)+1,pagesize:100},function(t){return t=t.result[d]||{},e?l.gridOptions.data=l.gridOptions.data.concat(t.sensor||[]):(l.gridOptions.data=t.sensor||[],l.gridOptions.data.length&&a(function(){l.gridApi.core.scrollTo(l.gridOptions.data[0],l.gridOptions.columnDefs[0])})),l.gridOptions.paging=t.paging,t}).$promise},c.bind("shown.bs.modal",function(){a(l.buildLine)}).bind("hidden.bs.modal",function(){l.gridApi.selection.clearSelectedRows(),delete l.curveModal,delete l.timeline}),l.date=n("date")(s,l.groupuser?"yyyy-MM":"yyyy-MM-dd"),u.bind("dp.change",function(){l.groupuser&&a(l.list)}),p.bind("dp.change",function(){l.curveModal&&a(l.channeldetail)}),l.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},l.timetype_current="DAY",l.timetypeChange=function(e){l.timetype_current=e,p.data("DateTimePicker").format({DAY:"YYYY-MM-DD",WEEK:"YYYY-MM-DD",MONTH:"YYYY-MM",YEAR:"YYYY"}[e]).viewMode({DAY:"days",WEEK:"days",MONTH:"months",YEAR:"years"}[e]).defaultDate(l.date),l.channeldetail()},l.lineType=function(e){l.curveModal.type=e,l.buildLine()},l.buildLine=function(){l.curveModal.enable&&(l.timeline={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:l.curveModal.categories,labels:{formatter:function(){return n("date")(this.value,{DAY:"H",WEEK:"M-dd",MONTH:"M-dd",YEAR:"yyyy-MM"}[l.timetype_current])}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y:.2f} '+l.curveModal.unit+"</span>"},series:[{name:l.curveModal.title,data:l.curveModal[l.curveModal.type]}]})},l.channeldetail=function(){l.curveModal.type=l.curveModal.type||"diff",l.curveModal.categories=[],l.curveModal.diff=[],l.curveModal.scale=[],l.curveModal.enable=!1,i.business.channeldetail({id:l.curveModal.id,timeformat:l.timetype_current,from:l.date.replace(/-/g,""),to:l.date.replace(/-/g,"")},function(e){e.result&&(angular.forEach(e.result.detail,function(e){l.curveModal.categories.push(e.timepoint),l.curveModal.diff.push(e.value),l.curveModal.scale.push(e.total)}),l.curveModal.enable=!0,l.curveModal.start=e.result.start,l.curveModal.unit=e.result.unit,c.hasClass("in")?l.buildLine():c.modal("show"))})},l}]);