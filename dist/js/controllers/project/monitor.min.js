EMAPP.templateCache.put("dist/html/project/monitor.min.html?rev=3ab24d9c8d",'<div class="app-view-project-monitor text-center ng-cloak"><div class="nav nav-tabs"><div class="btn-group"><a href="javascript:void(0)" class="btn btn-sm btn-primary" ng-class="{active:self.energyData.selected.id===item.id}" ng-repeat="item in self.energyData" ng-click="self.energyData.select(item)" ng-bind="item.title"></a></div><div class="pull-right"><b>状态切换：</b><div class="bootstrap-switch-square"><input type="checkbox" data-toggle="switch" data-on-color="primary" data-off-color="warning" data-on-text="正常" data-off-text="异常" id="showException" checked=""></div></div></div><table class="table table-bordered"><thead><tr><th class="text-center" style="width:60px;">序号</th><th class="text-center" style="width:130px;">设备标识</th><th class="text-center">设备名称</th><th class="text-center" style="width:130px;">通道名称</th><th class="text-center" style="width:100px;">能耗分类</th><th class="text-center" style="width:130px;">设备读数</th><th class="text-center" style="width:150px;">通讯时间</th><th class="text-center" style="width:100px;">状态</th></tr></thead></table><div slimscroll=""><table class="table table-bordered table-striped table-hover"><tbody><tr ng-repeat="item in self.monitorData" ng-click="self.channeldetail(self.curveModal=item)"><td style="width:60px;" ng-bind="$index+1"></td><td style="width:130px;" ng-bind="item.addr"></td><td ng-bind="item.title"></td><td style="width:130px;" ng-bind="item.channel"></td><td style="width:100px;" ng-bind="item.energycategory"></td><td style="width:130px;" ng-bind="item.lastvalue"></td><td style="width:150px;" ng-bind="item.time|date:\'yyyy/MM/dd HH:mm:ss\'"></td><td style="width:100px;"><b ng-show="item.status===0" class="ng-hide" style="color:#16a085;">正常</b> <b ng-show="item.status===1" class="ng-hide" style="color:#c0392b;">数据异常</b> <b ng-show="item.status===2" class="ng-hide" style="color:#8e44ad;">通讯异常</b></td></tr></tbody></table></div><div class="modal fade" id="curveModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button><h4 class="modal-title" ng-bind="self.curveModal.title"></h4></div><div class="modal-body"><div class="form-inline text-right"><div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" ng-model="self.date" datetimepicker="" required=""> <i class="form-control-feedback em em-calendar"></i></div><div class="btn-group btn-group-sm"><a class="btn btn-primary" href="javascript:void(0)" ng-repeat="(key,val) in self.timetype" ng-class="{active:self.timetype_current===key}" ng-click="self.timetypeChange(key)" ng-bind="val"></a></div><div class="btn-group btn-group-sm"><a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.curveModal.type===\'diff\'}" ng-click="self.lineType(\'diff\');">差值 <i class="em em-curve-area"></i></a> <a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.curveModal.type===\'scale\'}" ng-click="self.lineType(\'scale\');">刻度 <i class="em em-line-spacing"></i></a></div></div><div class="panel-body text-center"><div class="highcharts-panel" highcharts="self.timeline"></div></div></div></div></div></div></div>'),EMAPP.register.controller("project.monitor",["$api","$filter","$timeout","Lines",function(e,t,i,o){var a=this,n=new Date,r=$("#showException"),l=$("#curveModal"),c=l.find("input[datetimepicker]"),s=function(){$(".slimScrollDiv,div[slimscroll]").height($(window).height()-$("div[slimscroll]").offset().top-15)};return $(window).resize(s),s(),a.showException=0,r.bootstrapSwitch().on("switchChange.bootstrapSwitch",function(e,t){a.energyData&&i(function(){a.showException=t?0:1,a.energyData.select(a.energyData.selected)})}),a.timetype={DAY:"日",WEEK:"周",MONTH:"月",YEAR:"年"},a.timetype_current="DAY",a.date=t("date")(n,"yyyy-MM-dd"),a.timetypeChange=function(e){a.timetype_current=e,c.data("DateTimePicker").format({DAY:"YYYY-MM-DD",WEEK:"YYYY-MM-DD",MONTH:"YYYY-MM",YEAR:"YYYY"}[e]).viewMode({DAY:"days",WEEK:"days",MONTH:"months",YEAR:"years"}[e]).defaultDate(a.date),a.channeldetail()},e.energy.info({project:EMAPP.Project.current._id},function(e){angular.forEach(e.result.energy||{},function(e){this.push(e)},a.energyData=[]),(a.energyData.select=function(e){a.energyData.selected=e,a.monitorData=[],$("div[slimscroll]").slimScroll&&$("div[slimscroll]").slimScroll({scrollBy:0,scrollTo:0}),$("div.slimScrollBar").css({top:0}),a.list()})(a.energyData[0])}),a.list=function(t){a.monitorData.loading=!0,e.business.monitor(angular.extend({energytype:a.energyData.selected.id,project:EMAPP.Project.current._id,showexception:a.showException,pageindex:1,pagesize:100},angular.isObject(t)?t:angular.isNumber(t)?{pageindex:t}:{}),function(e){e=e.result[EMAPP.Project.current._id]||{},a.monitorData=a.monitorData.concat(e.sensor),a.monitorData.paging=e.paging||{pageindex:1,pagesize:100,count:0},i(s)})},a.channeldetail=function(){a.curveModal.type=a.curveModal.type||"diff",a.curveModal.categories=[],a.curveModal.diff=[],a.curveModal.scale=[],a.curveModal.enable=!1,e.business.channeldetail({id:a.curveModal.id,timeformat:a.timetype_current,from:a.date.replace(/-/g,""),to:a.date.replace(/-/g,"")},function(e){e.result&&(angular.forEach(e.result.detail,function(e){a.curveModal.categories.push(e.timepoint),a.curveModal.diff.push(e.value),a.curveModal.scale.push(e.total)}),a.curveModal.enable=!0,a.curveModal.start=e.result.start,a.curveModal.unit=e.result.unit,l.hasClass("in")?a.buildLine():l.modal("show"))})},a.lineType=function(e){a.curveModal.type=e,a.buildLine()},a.buildLine=function(){a.curveModal.enable&&(a.timeline=o({title:a.curveModal.title,type:"spline",xAxis:{categories:a.curveModal.categories,labels:{formatter:function(){return t("date")(this.value,{DAY:"HH",WEEK:"MM-dd",MONTH:"MM-dd",YEAR:"yyyy-MM"}[a.timetype_current])}}},series:[{name:a.curveModal.title,data:a.curveModal[a.curveModal.type]}],chart:{margin:[0,0,0,0],style:{textAlign:"center"}},tooltip:{shared:!0,xDateFormat:"%Y年%m月%d日 %H:00",headerFormat:"",pointFormat:"{series.name}: <b>{point.y:.2f} "+a.curveModal.unit+"</b><br/>"},plotOptions:{series:{cursor:"pointer"}}}))},i(function(){var e=$("div[slimscroll]"),t=$("div[slimscroll]>.table");e.slimScroll().bind("slimscroll",function(){e.scrollTop()+e.height()>=t.height()&&!a.monitorData.loading&&a.monitorData.paging&&a.monitorData.paging.count>t.find("tr").length&&a.list(a.monitorData.paging.pageindex+1)})},1e3),l.on("shown.bs.modal",function(){i(a.buildLine)}).on("hidden.bs.modal",function(){a.curveModal.diff=[],a.curveModal.scale=[],i(a.buildLine)}),c.on("dp.change",function(){a.curveModal&&i(a.channeldetail)}),a}]);