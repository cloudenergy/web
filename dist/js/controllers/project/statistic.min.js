EMAPP.templateCache.put("dist/html/project/statistic.min.html?rev=8da7fdb243",'<div class="app-view-project-statistic"><p class="text-right text-info"><i class="em em-light-empty"></i><small><strong>提示：</strong>可手动拖动调整列宽</small></p><ul class="nav nav-tabs ng-cloak"><li ng-repeat="(key,name) in self.tabs" ng-class="{active:self.tabActive===key}"><a ng-href="/dashboard/statistic/{{key}}" ng-bind="name"></a></li><li class="pull-right navbar form-inline"><div class="input-group"><div class="btn-group btn-group-sm"><button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><span ng-bind="self.energyData.selected.title||\'全部\'">全部</span> <span class="caret"></span></button><ul class="dropdown-menu"><li ng-class="{active:!self.energyData.selected}" ng-click="self.energyData.selected=null;self.report(self.tabActive)"><a href="javascript:void(0)">全部</a></li><li ng-repeat="item in self.energyData" ng-class="{active:self.energyData.selected.id===item.id}" ng-click="self.energyData.selected=item;self.report(self.tabActive)"><a href="javascript:void(0)" ng-bind="item.title"></a></li></ul></div></div><div class="form-group form-group-sm has-feedback date"><input type="text" class="form-control" id="start_date" ng-model="self.startDate" datetimepicker="" required=""> <i class="em em-calendar form-control-feedback"></i></div><div class="input-group" ng-show="self.tabActive!==\'dailyreport\'">至</div><div class="form-group form-group-sm has-feedback date" ng-show="self.tabActive!==\'dailyreport\'"><input type="text" class="form-control" id="end_date" ng-model="self.endDate" datetimepicker="" data-use-current="false" required=""> <i class="em em-calendar form-control-feedback"></i></div><div class="input-group btn-group btn-group-sm ng-hide" ng-show="self.tabActive===\'dailyreport\'"><a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.grid_timetype_current===\'usage\'}" ng-click="self.grid_timetype(\'usage\')">用量 <i class="em em-curve-area"></i></a> <a class="btn btn-info" href="javascript:void(0)" ng-class="{active:self.grid_timetype_current===\'scale\'}" ng-click="self.grid_timetype(\'scale\')">刻度 <i class="em em-line-spacing"></i></a></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.toggleFiltering()">筛选<i class="em em-filter"></i></button></div><div class="input-group btn-group-sm"><button type="button" class="btn btn-info" ng-click="self.export()">导出<i class="em em-export-excel"></i></button></div></li></ul><div class="tab-content ng-cloak"><div class="tab-pane subContent active" id="report"><div ui-grid="self.gridOptions" class="grid" ui-grid-auto-resize="" ui-grid-exporter="" ui-grid-move-columns="" ui-grid-resize-columns=""></div></div></div></div>'),EMAPP.register.controller("project.statistic",["$api","$filter","$timeout","$stateParams","i18nService","uiGridConstants",function(t,e,i,a,r,n){!function c(){$("#report").length&&$("#report").height($(window).height()-$("#report").offset().top-15),!arguments.length&&$(window).resize(c)}();var d=this,o=new Date,s=$("#start_date"),l=$("#end_date"),m=function(t){if(t.date&&t.oldDate){var e={settlereport:"YYYYMMDD",monthlyreport:"YYYYMMDD",dailyreport:"YYYYMMDD"}[d.tabActive],i=t.oldDate.format(e),a=t.date.format(e);a!==i&&d.report(d.tabActive)}};return s.on("dp.change",function(t){i(function(){l.data("DateTimePicker").minDate(t.date),"monthlyreport"===d.tabActive,m(t)})}),l.on("dp.change",function(t){i(function(){s.data("DateTimePicker").maxDate(t.date),m(t)})}),d.startDate=e("date")(o,"yyyy-MM-")+"01",d.endDate=e("date")(o,"yyyy-MM-dd"),t.energy.info({project:EMAPP.Project.current._id},function(t){angular.forEach(t.result.energy||{},function(t){this.push(t)},d.energyData=[])}),r.setCurrentLang("zh-cn"),d.toggleFiltering=function(){d.gridOptions.enableFiltering=!d.gridOptions.enableFiltering,d.gridApi.core.notifyDataChange(n.dataChange.COLUMN)},d["export"]=function(){switch(d.tabActive){case"settlereport":d.gridOptions.exporterCsvFilename=d.tabActive+"_"+d.startDate.replace(/\-/g,"")+"_"+d.endDate.replace(/\-/g,"")+".csv";break;case"monthlyreport":case"dailyreport":d.gridOptions.exporterCsvFilename=d.tabActive+"_"+d.startDate.replace(/\-/g,"")+".csv"}d.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},(d.grid_timetype=function(t){d.grid_timetype_current=t,d.rebuildData&&d.rebuildData(d.gridOptions.data)})("usage"),d.rebuildData=function(t){"monthlyreport"===d.tabActive&&angular.forEach(t,function(t){var e=0;angular.forEach(t.detail,function(i){e++,t["day"+e]=i})}),"dailyreport"===d.tabActive&&angular.forEach(t,function(t){var e=0;angular.forEach(t[d.grid_timetype_current],function(i){t["hour"+e]=i,e++})}),d.gridOptions.data=t},d.gridOptions={onRegisterApi:function(t){d.gridApi=t},enableColumnResizing:!0,exporterOlderExcelCompatibility:!0},d.tabs={settlereport:"结算报表",monthlyreport:"月报表",dailyreport:"日报表"},d.tabClick=function(t){d.tabActive=t,s.data("DateTimePicker")&&(s.data("DateTimePicker").format({settlereport:"YYYY-MM-DD",monthlyreport:"YYYY-MM-DD",dailyreport:"YYYY-MM-DD"}[t]).viewMode({settlereport:"days",monthlyreport:"months",dailyreport:"days"}[t]),d.startDate=s.data("DateTimePicker").date().format("YYYY-MM-DD")),d.report(t)},d.report=function(i){var a={project:[{id:EMAPP.Project.current._id,energy:d.energyData&&d.energyData.selected&&d.energyData.selected.id||""}]};switch(i){case"settlereport":case"monthlyreport":a.from=d.startDate.replace(/\-/g,""),a.to=d.endDate.replace(/\-/g,"");break;case"dailyreport":a.time=d.startDate.replace(/\-/g,"")}t.business[i](a,function(t){switch(t=t.result[EMAPP.Project.current._id]||[],i){case"settlereport":d.gridOptions.columnDefs=[{displayName:"传感器名称",name:"name",width:"*",minWidth:260},{displayName:"设备ID",name:"id.substr(12,12)",width:"*",minWidth:120},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100},{displayName:d.startDate,name:"min.toFixed(2)",width:"*",minWidth:100},{displayName:d.endDate,name:"max.toFixed(2)",width:"*",minWidth:100},{displayName:"能耗总值",name:"sum.toFixed(2)",width:"*",minWidth:100},{displayName:"单价",name:"price",width:"*",minWidth:100},{displayName:"费用",name:"cost.toFixed(2)",width:"*",minWidth:100}];break;case"monthlyreport":if(d.gridOptions.columnDefs=[{displayName:"传感器名称",name:"name",width:"*",minWidth:260},{displayName:"设备ID",name:"channeldid.substr(12,12)",width:"*",minWidth:120},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100},{displayName:"月能耗",name:"monthlySum.toFixed(2)",width:"*",minWidth:100},{displayName:"日平均",name:"dailyAvg.toFixed(2)",width:"*",minWidth:100}],t.length){var a=0;angular.forEach(t[0].detail,function(t,i){a++,this.push({displayName:e("date")(i,"M月d号"),name:"day"+a+".toFixed(2)",width:"*",minWidth:100})},d.gridOptions.columnDefs)}break;case"dailyreport":if(d.gridOptions.columnDefs=[{displayName:"传感器名称",name:"name",width:"*",minWidth:260},{displayName:"设备ID",name:"channeldid.substr(12,12)",width:"*",minWidth:120},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100},{displayName:"日能耗",name:"dailysum.toFixed(2)",width:"*",minWidth:100}],t.length){var a=0;angular.forEach(t[0].usage,function(t,e){this.push({displayName:a+"时",name:"hour"+a+".toFixed(2)",width:"*",minWidth:100}),a++},d.gridOptions.columnDefs)}}d.rebuildData(t)})},d.tabClick(a.tab||"settlereport"),d}]);